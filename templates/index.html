{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>한국건설품질시험원(주)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/jquery-1.12.3.min.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>    
</head>
<style>
/* 배경색 부드럽게 */
    .bg-light { background-color: #f8f9fa !important; }

    /* 카드 기본 스타일 */
    .stat-card {
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        border-radius: 12px;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.08) !important;
    }

    /* 클릭된 카드의 강조 효과 (청록색 포인트) */
    .stat-card.active {
        background: #ffffff;
        border-left: 6px solid #007BA7 !important;
    }
    
    .stat-card.active h6 { color: #007BA7 !important; font-weight: bold; }

    /* 그래프 컨테이너 여백 */
    .chart-wrapper {
        margin-top: 20px;
    } 

</style>
<body>

<div class="top-auth-bar py-1 border-bottom">
    
    <div class="container-fluid d-flex justify-content-between align-items-center px-5 py-1">   
    
        <div class="logo-area">
            <a href="/" class="d-flex align-items-center text-decoration-none">
                <img src="{% static 'images/kcqt_logo.jpg' %}" alt="Logo" style="height: 28px; width: auto;">
                <span class="ms-2 fw-bold text-dark d-none d-sm-inline">한국건설품질시험원(주)</span>
            </a>
        </div>

        <div class="d-flex align-items-center gap-2">
            <a href="/" class="btn btn-sm btn-outline-secondary py-0 d-flex align-items-center gap-1" title="메인페이지로 이동">
                <i class="bi bi-house-door"></i> 홈
            </a>
            
            <div class="vr mx-1"></div> {% if user.is_authenticated %}
                <span class="small me-2"><strong>{{ user.username }}</strong>님</span>
                <form action="/logout/" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger py-0">로그아웃</button>
                </form>
            {% else %}
                <form action="/login/" method="post" class="d-flex gap-2">
                    {% csrf_token %}
                    <input type="text" name="username" class="form-control form-control-sm" placeholder="아이디" style="width: 100px;" required>
                    <input type="password" name="password" class="form-control form-control-sm" placeholder="비밀번호" style="width: 100px;" required>
                    <button type="submit" class="btn btn-sm btn-primary py-0">로그인</button>
                </form>
                <a href="/signup/" class="btn btn-sm btn-success py-0">회원가입</a>
            {% endif %}
        </div>
        

    </div>
</div>

<!-- 여기부터 메뉴바 -->
<nav class="main-menu-bar shadow-sm">
    <div class="container p-0">
        <ul class="nav justify-content-center">
            <li class="nav-item dropdown-container">
                <a class="nav-link" href="javascript:void(0);">접수건 팀배정</a>
                <div class="sliding-submenu">
                    <div class="submenu-inner">
                        <ul class="submenu-list">
                            <li><a href="#" onclick="checkLogin('/board/csi_receipt/')">배정하기</a></li>
                            <li><a href="#" onclick="checkAdminAccess('/board/csi_issue/')">발급일 가져오기</a></li>
                            <li><a href="#" onclick="checkAdminAccess('/board/csi_pending/')">작업중</a></li>
                        </ul>
                    </div>
                </div>
            </li>
            
            <li class="nav-item"><a class="nav-link" href="#" onclick="checkLogin('/request/')">접수 현황 및 실적 확인</a></li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="checkAdminAccess('/field_payment/')">현장</a>
            </li>
            <!-- <li class="nav-item">
                <a class="nav-link" href="#" onclick="checkAdminAccess('/receipt_settle_admin/')">시험</a>
            </li> -->
            <li class="nav-item dropdown-container">
                <a class="nav-link" href="javascript:void(0);">시험</a>
                
                <div class="sliding-submenu">
                    <div class="submenu-inner">
                        <ul class="submenu-list">
                            <li><a href="#" onclick="checkAdminAccess('/receipt_settle_admin/')">시험팀 월마감</a></li>
                            <li><a href="#" onclick="checkAdminAccess('/settlement_admin/')">월마감 관리</a></li>
                            <li><a href="#" onclick="checkAdminAccess('/exam_schedule/')">작업중</a></li>
                        </ul>
                    </div>
                </div>
            </li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="checkAdminAccess('/notice/')">일정관리</a></li>            
        
        </ul>
    </div>
</nav>


<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-3">
            <div class="d-flex flex-column gap-3">
                <h5 class="fw-bold mb-2">실적 요약(Q,T,E건 제외)</h5>
                
                <div class="card stat-card active" onclick="changeViewMode('daily', this)" style="cursor: pointer;">
                    <div class="card-body">
                        <h6 class="text-muted small">일일 업무 현황</h6>                      
                        <h3 class="fw-bold mb-0">
                            <span id="dailyCountValue">0건 / 발급 0건</span> 
                            <span class="text-success small" style="font-size: 0.5em;"></span>
                        </h3>    
                        
                    </div>
                </div>

                <div class="card stat-card" onclick="changeViewMode('yearly', this)" style="cursor: pointer;">
                    <div class="card-body">
                        <h6 class="text-muted small">연간 누적 실적</h6>
                        <h3 class="fw-bold mb-0">
                            <span id="yearlyCountValue">0건 / 발급 0건</span> 
                            <span class="text-primary small" style="font-size: 0.5em;" id="yearLabel"></span>
                        </h3>
                    </div>
                </div>

                <!-- <div class="card stat-card shadow-sm border-0" onclick="changeViewMode('invoice', this)" style="cursor: pointer;">
                    <div class="card-body">
                        <h6 class="text-muted small">작업중</h6>
                        <h3 class="fw-bold mb-0">₩128.5M <span class="text-warning small" style="font-size: 0.5em;">이달의 매출</span></h3>
                    </div>
                </div>

                <div class="card stat-card shadow-sm border-0" onclick="changeViewMode('payment', this)" style="cursor: pointer;">
                    <div class="card-body">
                        <h6 class="text-muted small">작업중</h6>
                        <h3 class="fw-bold mb-0">₩92.0M <span class="text-info small" style="font-size: 0.5em;">회수율 71%</span></h3>
                    </div>
                </div> -->
            </div>
        </div>

        <div class="col-lg-9">
            <div class="card shadow-sm border-0" style="min-height: 800px;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h5 class="fw-bold mb-0" id="chartTitle">일일 업무 현황</h5>
                            <p class="text-muted small mb-0">실시간 데이터 분석 현황입니다.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <select id="yearSelect" class="form-select form-select-sm" onchange="updateChartData()">
                                <option value="2025">2025년</option>
                                <option value="2026" selected>2026년</option>
                                <option value="2027">2027년</option>
                                <option value="2028">2028년</option>
                                <option value="2029">2029년</option>
                                <option value="2030">2030년</option>
                            </select>
                            <select id="monthSelect" class="form-select form-select-sm" onchange="updateChartData()">
                                <option value="1" selected>1월</option>
                                <option value="2">2월</option>
                                <option value="3">3월</option>
                                <option value="4">4월</option>
                                <option value="5">5월</option>
                                <option value="6">6월</option>
                                <option value="7">7월</option>
                                <option value="8">8월</option>
                                <option value="9">9월</option>
                                <option value="10">10월</option>
                                <option value="11">11월</option>
                                <option value="12">12월</option>                                
                            </select>
                        </div>
                    </div>
                    
                    <div style="position: relative; height: 650px; width: 100%;">
                        <canvas id="mainDashboardChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- 여기부터 CSI_접수 창 입니다 -->
<li>
    <a href="#" onclick="openPopup('/board/csi_receipt/')"></a>  
</li>

<script>
// ------------------여기서 부터 챠트 시작-----------str


let mainChart = null;
let currentMode = 'daily'; // 현재 보고 있는 모드 (기본값: 일일)

// 팀별 고유 색상 설정
const teamColors = [
    '#FFD700', // 1팀: 노랑
    '#FF8C00', // 2팀: 주황
    '#87CEEB', // 3팀: 하늘색
    '#2E8B57', // 4팀: 녹색
    '#808080', // 5팀: 그레이
    '#DAA520'  // 6팀: 황색
];

document.addEventListener('DOMContentLoaded', function() {
    initChart();
});

// 1. 차트 초기화
function initChart() {
    const ctx = document.getElementById('mainDashboardChart');
    if (!ctx) return;

    mainChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: [],
        datasets: [] 
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { grid: { display: false } },
            y: { 
                beginAtZero: true, 
                ticks: { 
                    precision: 0,
                    stepSize: 5  // ⬅️ 이 줄을 추가하세요! (눈금을 10단위로 고정)
                },
                suggestedMax: 80 // 데이터가 적어도 일단 100까지는 눈금을 그려줌 
            }
        },
        plugins: {
            legend: { position: 'top', align: 'end' }
        }
    }
});
    updateChartData();
}

// 2. 카드 클릭 시 모드 변경 (중요: 독립적 업데이트의 핵심)
window.changeViewMode = function(mode, element) {
    currentMode = mode;

    // UI 활성화 처리 (카드 강조)
    document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
    if (element) element.classList.add('active');

    // 타이틀 및 월 선택 드롭다운 제어
    const titleEl = document.getElementById('chartTitle');
    const monthEl = document.getElementById('monthSelect');
    const titles = {
        'daily': '일일 업무 현황',
        'yearly': '연간 누적 실적 추이',
        'invoice': '계산서 발행 현황',
        'payment': '입금 완료 현황'
    };

    if (titleEl) titleEl.innerText = titles[mode];
    // 연간 모드일 때는 '월' 선택 창을 숨깁니다.
    if (monthEl) monthEl.style.visibility = (mode === 'yearly') ? 'hidden' : 'visible';

    // 해당 모드에 맞춰 데이터 새로고침
    updateChartData();
};

// function updateChartData() {
//     const yearSelect = document.getElementById('yearSelect');
//     const monthSelect = document.getElementById('monthSelect');
//     if (!yearSelect) return;

//     const year = yearSelect.value;
//     const month = monthSelect ? monthSelect.value : "1";

//     fetch(`/api/get-stats/?year=${year}&month=${month}&mode=${currentMode}`)
//         .then(res => {
//             if (!res.ok) throw new Error(`HTTP 에러! 상태: ${res.status}`);
//             return res.json();
//         })
//         .then(data => {
//             const stats = data || {};
//             const teamNames = ['1팀', '2팀', '3팀', '4팀', '5팀', '6팀'];
//             const lastDay = (currentMode === 'yearly') ? 12 : new Date(year, month, 0).getDate();
            
//             // -----------------------------------------------------------
//             // [사용자님 아이디어 반영: 강제 합산 로직]
//             // 백엔드가 준 합계(486)는 버리고, 그래프에 들어갈 숫자들만 직접 더합니다.
//             // -----------------------------------------------------------
//             let realIssueSum = 0;
//             let realReceiptSum = 0;

//             teamNames.forEach(team => {
//                 const teamData = stats[team];
//                 if (teamData) {
//                     // 팀별 발급(issue) 배열의 합계를 구함 (예: 151 + 0 + ...)
//                     if (Array.isArray(teamData.issue)) {
//                         realIssueSum += teamData.issue.reduce((acc, curr) => acc + (Number(curr) || 0), 0);
//                     }
//                     // 팀별 접수(receipt) 배열의 합계를 구함
//                     if (Array.isArray(teamData.receipt)) {
//                         realReceiptSum += teamData.receipt.reduce((acc, curr) => acc + (Number(curr) || 0), 0);
//                     }
//                 }
//             });

//             // 1. UI 업데이트 (좌측 합계 메뉴)
//             // 여기서 iSum 자리에 우리가 직접 계산한 realIssueSum(483)이 들어갑니다.
//             const updateUI = (id, rSum, iSum, label, colorClass) => {
//                 const el = document.getElementById(id);
//                 if (el) {
//                     el.innerHTML = `${rSum.toLocaleString()}건 / <span style="color:#2f55d4">발급 ${iSum.toLocaleString()}건</span> <span class="${colorClass} small" style="font-size: 0.5em; margin-left:5px;">${label}</span>`;
//                 }
//             };

//             if (currentMode === 'daily') {
//                 updateUI('dailyCountValue', realReceiptSum, realIssueSum, 'Today', 'text-success');
//             } else if (currentMode === 'yearly') {
//                 updateUI('yearlyCountValue', realReceiptSum, realIssueSum, `${year}년`, 'text-primary');
//             }

//             // 2. 차트(그래프) 업데이트 로직
//             if (mainChart) {
//                 const labels = Array.from({length: lastDay}, (_, i) => (currentMode === 'yearly' ? `${i+1}월` : `${i+1}일`));
                
//                 const newDatasets = teamNames.map((team, i) => ({
//                     type: 'bar',
//                     label: team,
//                     data: (stats[team]?.receipt || Array(lastDay).fill(0)).slice(0, lastDay),
//                     backgroundColor: teamColors[i],
//                     borderRadius: 4,
//                     order: 2
//                 }));

//                 let zigzagPoints = [];
//                 for (let d = 0; d < lastDay; d++) {
//                     teamNames.forEach((team, tIdx) => {
//                         const val = Number(stats[team]?.issue?.[d] || 0);
//                         const barOffset = (tIdx - (teamNames.length - 1) / 2) * (0.8 / teamNames.length);
//                         zigzagPoints.push({ x: d + barOffset, y: val });
//                     });
//                 }

//                 newDatasets.push({
//                     type: 'line',
//                     label: '발급 건수',
//                     data: zigzagPoints,
//                     borderColor: '#2f55d4',
//                     borderWidth: 2,
//                     pointBackgroundColor: 'red',
//                     pointRadius: 4,
//                     pointStyle: 'star',
//                     fill: false,
//                     tension: 0,
//                     order: 1,
//                     parsing: false
//                 });

//                 mainChart.data.labels = labels;
//                 mainChart.data.datasets = newDatasets;
//                 mainChart.update();
//             }
//         })
//         .catch(err => {
//             console.error("데이터 로딩 중 오류:", err);
//         });
// }

function updateChartData() {
    const yearSelect = document.getElementById('yearSelect');
    const monthSelect = document.getElementById('monthSelect');
    if (!yearSelect) return;

    const year = yearSelect.value;
    const month = monthSelect ? monthSelect.value : "1";

    fetch(`/api/get-stats/?year=${year}&month=${month}&mode=${currentMode}`)
        .then(res => {
            if (!res.ok) throw new Error(`HTTP 에러! 상태: ${res.status}`);
            return res.json();
        })
        .then(data => {
            const stats = data || {};
            const teamNames = ['1팀', '2팀', '3팀', '4팀', '5팀', '6팀'];
            const lastDay = (currentMode === 'yearly') ? 12 : new Date(year, month, 0).getDate();
            
            let realIssueSum = 0;
            let realReceiptSum = 0;
            let realMatchedSum = 0;

            teamNames.forEach(team => {
                const teamData = stats[team];
                if (teamData) {
                    if (Array.isArray(teamData.issue)) {
                        realIssueSum += teamData.issue.reduce((acc, curr) => acc + (Number(curr) || 0), 0);
                    }
                    if (Array.isArray(teamData.receipt)) {
                        realReceiptSum += teamData.receipt.reduce((acc, curr) => acc + (Number(curr) || 0), 0);
                    }
                    if (Array.isArray(teamData.matched_issue)) {
                        realMatchedSum += teamData.matched_issue.reduce((acc, curr) => acc + (Number(curr) || 0), 0);
                    }
                }
            });

            // 1. UI 업데이트
            const updateUI = (id, rSum, iSum, mSum, label, colorClass) => {
                const el = document.getElementById(id);
                if (el) {
                    el.innerHTML = `
                        ${rSum.toLocaleString()}건 / <span style="color:#2f55d4">발급 ${iSum.toLocaleString()}건</span>
                        <div class="mt-1" style="color:#28a745; font-size: 0.75em; font-weight: bold;">
                            [의뢰번호 매칭 발급완료 건수: ${mSum.toLocaleString()}건]
                        </div>
                        <span class="${colorClass} small" style="font-size: 0.5em; margin-left:5px;">${label}</span>
                    `;
                }
            };

            if (currentMode === 'daily') {
                updateUI('dailyCountValue', realReceiptSum, realIssueSum, realMatchedSum, 'Today', 'text-success');
            } else if (currentMode === 'yearly') {
                updateUI('yearlyCountValue', realReceiptSum, realIssueSum, realMatchedSum, `${year}년`, 'text-primary');
            }

            // 2. 차트 업데이트
            if (mainChart) {
                const labels = Array.from({length: lastDay}, (_, i) => (currentMode === 'yearly' ? `${i+1}월` : `${i+1}일`));
                
                // [막대] 팀별 접수
                const newDatasets = teamNames.map((team, i) => ({
                    type: 'bar',
                    label: team,
                    data: (stats[team]?.receipt || Array(lastDay).fill(0)).slice(0, lastDay),
                    backgroundColor: teamColors[i],
                    borderRadius: 4,
                    order: 3
                }));

                // -----------------------------------------------------------
                // [수정 포인트] 녹색선 지그재그 로직 (파란선과 동일한 방식)
                // -----------------------------------------------------------
                let matchedZigzag = [];
                let issueZigzag = [];

                for (let d = 0; d < lastDay; d++) {
                    teamNames.forEach((team, tIdx) => {
                        // 막대 위치 계산 (중앙 정렬 오프셋)
                        const barOffset = (tIdx - (teamNames.length - 1) / 2) * (0.8 / teamNames.length);
                        
                        // 1. 녹색선 데이터 (의뢰 기준 매칭)
                        const mVal = Number(stats[team]?.matched_issue?.[d] || 0);
                        matchedZigzag.push({ x: d + barOffset, y: mVal });

                        // 2. 파란선 데이터 (단순 발급 행위)
                        const iVal = Number(stats[team]?.issue?.[d] || 0);
                        issueZigzag.push({ x: d + barOffset, y: iVal });
                    });
                }

                // 녹색선 추가
                newDatasets.push({
                    type: 'line',
                    label: '의뢰번호 매칭 발급완료 건수(녹색)',
                    data: matchedZigzag,
                    borderColor: '#28a745',
                    borderWidth: 2.5,
                    pointBackgroundColor: '#28a745',
                    pointRadius: 4,
                    pointStyle: 'circle', // 파란선과 구분하기 위해 동그라미 사용
                    fill: false,
                    tension: 0,
                    order: 1,
                    parsing: false // 좌표 방식 사용 시 필수
                });

                // 파란선 추가
                newDatasets.push({
                    type: 'line',
                    label: '해당일자 발급 총건수(파랑)',
                    data: issueZigzag,
                    borderColor: '#2f55d4',
                    borderWidth: 2,
                    pointBackgroundColor: 'red',
                    pointRadius: 4,
                    pointStyle: 'star',
                    fill: false,
                    tension: 0,
                    order: 2,
                    parsing: false
                });

                mainChart.data.labels = labels;
                mainChart.data.datasets = newDatasets;
                mainChart.update();
            }
        })
        .catch(err => console.error("오류:", err));
}



    //----------------여기서 부터 관리자---------------
    
        // 1. 로그인 여부를 장고 템플릿 태그로 정의 (이게 반드시 있어야 함)
const isAuthenticated = "{{ user.is_authenticated|yesno:'true,false' }}" === "true";

// 2. 일반 메뉴용 함수
function checkLogin(targetUrl) {
    if (isAuthenticated) {
        location.href = targetUrl;
    } else {
        alert("로그인을 해주세요.");
        document.querySelector('input[name="username"]')?.focus();
    }
}

// 3. CSI_접수 전용 팝업 함수
function openPopup(url) {
    if (isAuthenticated) {
        // 새 창 띄우기
        window.open(url, 'csi_popup', 'width=1300,height=900,scrollbars=yes,resizable=yes');
    } else {
        alert("로그인을 해주세요.");
        document.querySelector('input[name="username"]')?.focus();
    }
}

function checkAdminAccess(url) {
    // 1. 로그인 여부 먼저 확인
    const isAuthenticated = "{{ user.is_authenticated }}" === "True";
    const currentUserId = "{{ user.username }}"; // 현재 로그인한 아이디
    
    // 2. 허용된 아이디 리스트
    const allowedIds = ["admin_work", "admin_home","안월숙"];

    if (!isAuthenticated) {
        alert("로그인이 필요한 서비스입니다.");
        location.href = "/login/"; // 로그인 페이지로 유도
        return;
    }

    // --- 추가된 로직: 일정관리 전용 제한 field_payment---
    if (url.includes('/notice/') && currentUserId !== 'admin_home') {
        alert("해당 메뉴에 대한 접근 권한이 없습니다.");
        return;
    }

    if (url.includes('/field_payment/') && currentUserId !== 'admin_home') {
        alert("해당 메뉴에 대한 접근 권한이 없습니다.");
        return;
    }
    // ------------------------------------

    // 3. 아이디 권한 확인
    if (allowedIds.includes(currentUserId)) {
        location.href = url; // 권한이 있으면 이동
    } else {
        alert("해당 메뉴에 대한 접근 권한이 없습니다.");
    }
} 


</script>
</body>
</html>