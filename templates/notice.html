{% extends "base.html" %}
{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
/* --- 기본 레이아웃 구성 --- */
/* --- 기본 레이아웃 구성 --- */
.consult-integrated-wrapper {
    display: flex;
    height: calc(100vh - 165px);
    margin: -1rem;
    padding: 15px;
    background-color: #f4f6f9;
    gap: 15px;
    overflow: hidden; 
}

/* 1. 왼쪽 사이드바: 전체 화면 높이에 딱 맞게 고정 */
.sidebar-left {
    width: 320px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: 15px;
    height: 100%; /* 부모 높이를 가득 채움 */
    overflow: hidden; /* 사이드바 밖으로 삐져나오지 않게 함 */
}

/* 2. 담당자 검색 카드: 상단에 고정 */
.sidebar-left .dashboard-card:first-child {
    height: 50%; /* 검색 영역이 화면의 딱 절반을 쓰도록 설정 (조절 가능) */
    min-height: 300px;
    display: flex;
    flex-direction: column;
    flex-shrink: 0; /* 캘린더에 의해 줄어들지 않음 */
}

/* 3. 검색 데이터 리스트: 카드 내부에서 꽉 차게 늘어남 (핵심) */
#client_list {
    flex: 1;               /* 카드 내부의 남은 공간을 무조건 꽉 채움 */
    overflow-y: auto !important; /* 데이터 많으면 여기서만 스크롤 */
    display: block;        /* 데이터 블록이 사라지지 않게 보장 */
    min-height: 0;
    background: #fff;
}

/* 4. 캘린더 카드: 검색창 바로 아래 남은 공간 전체 사용 */
.calendar-container-card {
    flex: 1;               /* 하단 남은 공간을 100% 다 사용 */
    min-height: 350px;     /* 캘린더가 너무 작아지지 않게 최소 높이 보장 */
    display: flex;
    flex-direction: column;
    padding: 10px !important;
}

/* 캘린더 내부 실제 영역 */
#calendar {
    flex: 1;
    height: 100%;
    min-height: 0;
}

/* 캘린더 폰트 및 버튼 크기 축소 (이미지처럼 좁은 곳에 최적화) */
.fc .fc-toolbar-title { font-size: 0.85rem !important; }
.fc .fc-button { padding: 1px 4px !important; font-size: 0.65rem !important; }
.fc-daygrid-day-number { font-size: 0.7rem; }
.fc .fc-daygrid-day-frame { min-height: 35px !important; }

/* --- 중앙 및 오른쪽 영역 유지 --- */
.main-consult-area { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 15px; }
.sidebar-right { width: 320px; flex-shrink: 0; }
.dashboard-card { background: white; border-radius: 10px; border: 1px solid #dee2e6; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

/* 담당자 카드 스타일 */
.contact-card { padding: 12px; border-radius: 8px; background: #f8fafc; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; }
.contact-card:hover { background: #eef2ff; border-color: #0d6efd; }
.contact-card.active { background: #eef2ff; border-color: #0d6efd; }
</style>

<div class="consult-integrated-wrapper">
    <aside class="sidebar-left">
        <div class="dashboard-card">
            <div class="p-3 border-bottom bg-light">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold mb-0 small"><i class="bi bi-person-lines-fill me-2"></i>담당자 검색</h6>
                    
                    <div class="form-check form-switch ms-auto me-2">
                        <input class="form-check-input" type="checkbox" id="copy_current_info" style="cursor:pointer;">
                        <label class="form-check-label small fw-bold" for="copy_current_info" style="cursor:pointer; font-size: 0.75rem;">기존정보 활용</label>
                    </div>

                    <button type="button" class="btn btn-success btn-sm btn-register-plus" onclick="openRegisterModal()">
                        <i class="bi bi-person-plus-fill"></i>
                    </button>
                </div>
                <div class="input-group input-group-sm">
                    <input type="text" id="search_keyword" class="form-control" placeholder="성함 또는 업체명..." 
                        onkeyup="if(window.event.keyCode==13){search_clients()}">
                    <button class="btn btn-primary" type="button" onclick="search_clients()">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
            <div class="list-group list-group-flush scrollarea" id="client_list">
                <div class="p-4 text-center text-muted small">
                    <i class="bi bi-search d-block mb-2" style="font-size: 2rem;"></i>
                    검색을 시작해주세요.
                </div>
            </div>
        </div>

        <div class="dashboard-card calendar-container-card">
            <div id="calendar"></div>
        </div>
    </aside>

    <main class="main-consult-area d-flex flex-column gap-3">
        <div class="dashboard-card p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <div class="mb-1">
                        <span id="info_name" class="fw-bold text-dark" style="font-size: 1rem;"></span>
                        <span id="info_phone" class="text-muted ms-2" style="font-size: 0.85rem;"></span>
                    </div>

                    <h5 id="current_project_title" class="text-primary fw-bold mb-0">
                        프로젝트를 선택해주세요
                    </h5>
                </div>

                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-primary" onclick="manageFolder('create')">
                        <i class="bi bi-folder-plus"></i> 폴더생성
                    </button>
                    
                    <button class="btn btn-sm btn-outline-dark" onclick="manageFolder('open')">
                        <i class="bi bi-folder2-open"></i> 폴더열기
                    </button>                    
                </div>
            </div>
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-white py-2">
                    <h6 class="m-0 font-weight-bold text-primary small" id="selected_project_name">상세 내역 리스트</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-bordered table-sm table-hover mb-0" style="min-width: 1000px; font-size: 0.7rem;">
                            <thead class="table-dark sticky-top">
                                <tr class="text-center">
                                    <th>의뢰번호</th><th>QT번호</th><th>접수일</th><th>봉인명</th>
                                    <th>공급가액</th><th>입금일</th><th>입금액</th><th>발행업체</th><th>발행일</th>
                                </tr>
                            </thead>
                            <tbody id="project_detail_list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-card flex-grow-1 overflow-hidden d-flex flex-column">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-white sticky-top">
                <h6 class="fw-bold mb-0 text-primary small"><i class="bi bi-chat-left-text-fill me-2"></i>상담 및 업무 메모</h6>
                <div class="d-flex gap-1">
                    <button type="button" class="btn btn-info btn-xs memo-save-btn" data-category="견적예약">견적</button>
                    <button type="button" class="btn btn-warning btn-xs memo-save-btn" data-category="세발예약">세발</button>
                    <button type="button" class="btn btn-success btn-xs memo-save-btn" data-category="시험예약">시험</button>
                    <button type="button" class="btn btn-secondary btn-xs memo-save-btn" data-category="일반예약">일반</button>
                    <button type="button" class="btn btn-dark btn-xs memo-save-btn" data-category="입찰예약">입찰</button>
                </div>
            </div>
            <div class="p-2 border-bottom bg-light">
                <textarea id="memo_content" class="form-control form-control-sm" rows="3" placeholder="내용을 기록하세요..."></textarea>
            </div>
            <div class="p-3 flex-grow-1 overflow-auto">
                <h6 class="fw-bold extra-small mb-2 text-muted">과거 상담 히스토리</h6>
                <div id="memo_history_area"></div>
            </div>
        </div>
    </main>

    <aside class="sidebar-right">
        <div class="dashboard-card p-3 h-100 d-flex flex-column" style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;">
            <h6 class="fw-bold small mb-3 text-danger border-bottom pb-2">
                <i class="bi bi-clock-history"></i> 업무 예약 (D-Day)
            </h6>
            <div id="task_list_area" class="flex-grow-1 overflow-auto">
                <div class="text-center text-muted small p-3">진행 중인 업무가 없습니다.</div>
            </div>
        </div>
    </aside>
</div>
<div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white py-2">
                <h6 class="modal-title fw-bold small"><i class="bi bi-person-plus-fill me-2"></i>신규 담당자 및 프로젝트 등록</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="clientRegForm">
                    {% csrf_token %}
                    <input type="hidden" id="reg_client_id" name="reg_client_id"> 
                    <div class="row g-3 mb-3">
                       
                        <div class="col-6">
                            <label class="form-label small fw-bold">담당자 성함</label>
                            <input type="text" class="form-control form-control-sm" id="reg_name" name="reg_name" required placeholder="예: 김철수">                            
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold">연락처 (Unique)</label>
                            <input type="text" class="form-control form-control-sm" id="reg_phone" name="reg_phone" required placeholder="010-0000-0000">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">이메일 주소</label>
                        <input type="email" class="form-control form-control-sm" id="reg_email" name="reg_email" placeholder="example@email.com">
                    </div>

                    <div class="p-3 bg-light rounded-3 mb-3 border">
                        <h6 class="fw-bold small mb-3 text-primary"><i class="bi bi-link-45deg me-1"></i>MSSQL 프로젝트 연결</h6>
                        <div class="mb-3">
                            <label for="reg_company" class="form-label small fw-bold">시공사/발주처</label>
                            <input type="text" id="reg_company" name="reg_company" class="form-control form-control-sm" placeholder="사업명 확인 시 자동 입력됩니다">
                        </div>
                        <div class="mb-0">
                            <label for="reg_project_name" class="form-label small fw-bold">사업명</label>
                            <div class="input-group input-group-sm">
                                <input type="text" id="reg_project_name" name="reg_project_name" class="form-control" placeholder="사업명을 입력하세요">
                                <button type="button" class="btn btn-secondary" onclick="checkProject()">확인</button>
                            </div>
                            <div id="check_result" class="mt-1"></div> </div>
                    </div>
                    <button type="submit" class="btn btn-success btn-sm w-100 fw-bold py-2">데이터베이스에 저장</button>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
var calendar;
let currentClientId = null; 

// 스크립트 시작 부분에 추가
let tempClientData = { 
    name: '', 
    phone: '', 
    email: '', 
    company: '', 
    projectName: '', // 추가
    clientId: null   // 추가
};

// 1. 모달 열기 함수 (중복 생성 방지 로직 추가)

window.openRegisterModal = function() {
    const modalEl = document.getElementById('registerModal');
    if (!modalEl) return;

    // 1. 초기화 (모달 열 때마다 이전 ID 삭제)
    $('#reg_client_id').val(''); 
    $('#reg_name, #reg_phone, #reg_company, #reg_email, #reg_project_name').val('');

    // 2. '기존정보 활용' 체크 시 데이터 채우기
    if ($('#copy_current_info').is(':checked')) {
        
        if (!tempClientData.name) {
            alert("먼저 왼쪽 리스트에서 현장명을 클릭해 주세요!");
            return;
        }

        // [핵심] Hidden 필드에 DB ID(PK) 값을 넣어줍니다.
        $('#reg_client_id').val(tempClientData.clientId); 

        // 다른 필드들도 채워줍니다.
        $('#reg_name').val(tempClientData.name);
        $('#reg_phone').val(tempClientData.phone);
        $('#reg_email').val(tempClientData.email);
        $('#reg_project_name').val(tempClientData.projectName);
        $('#reg_company').val(tempClientData.company);
        
        console.log("모달에 주입된 ID:", tempClientData.clientId); // 확인용 로그
        setTimeout(() => $('#reg_project_name').focus(), 500);
    }

    let myModal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
    myModal.show();
};



    // 2. [사업명 확인] 버튼 클릭 시 MSSQL 데이터 조회
    // HTML 버튼의 onclick="checkMsProject()"를 "checkProject()"로 바꾸거나 아래 이름을 맞춤
    window.checkProject = function() {
        const projectName = document.getElementById('reg_project_name').value;
        const companyInput = document.getElementById('reg_company');
        const resultArea = document.getElementById('check_result');

        if (!projectName) {
            alert("사업명을 입력해주세요.");
            return;
        }

        if (resultArea) resultArea.innerHTML = '<span class="text-muted small">조회 중...</span>';

        fetch(`/get_project_detail/?project_name=${encodeURIComponent(projectName)}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // DB에 정보가 있는 경우
                if (companyInput) {
                    companyInput.value = data.builder;
                    companyInput.style.backgroundColor = "#e8f0fe";
                }
                if (resultArea) {
                    resultArea.innerHTML = `<span class="text-primary fw-bold"><i class="bi bi-check-circle"></i> 확인됨 (시공사: ${data.builder})</span>`;
                }
                alert(`현장 정보 확인: 시공사는 [${data.builder}]입니다.`);
            } else if (data.status === 'empty') {
                // 신규 현장인 경우
                if (companyInput) {
                    companyInput.value = "";
                    companyInput.focus();
                    companyInput.style.backgroundColor = "#ffffff";
                }
                if (resultArea) {
                    resultArea.innerHTML = `<span class="text-warning fw-bold"><i class="bi bi-exclamation-triangle"></i> 신규 현장 (직접 입력 가능)</span>`;
                }
                alert("신규 현장입니다. 시공사/발주처를 직접 입력해주세요.");
            } else {
                alert("에러 발생: " + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("서버 통신 중 오류가 발생했습니다.");
        });
    };

    // 3. 사이드바 항목 클릭 시 메인 화면에 정보 표시 (테스트용 데이터 유지)
    window.selectProject = function(reqNo) {
        const reqNoDisplay = document.getElementById('ms_req_no');
        const nameDisplay = document.getElementById('display_project_name');
        
        if (reqNoDisplay) reqNoDisplay.innerText = reqNo;
        
        if (nameDisplay) {
            if (reqNo === 'QT26-001') {
                nameDisplay.innerText = "[GS건설] A아파트 신축공사";
            } else {
                nameDisplay.innerText = "[두산건설] B아파트 신축공사";
            }
        }
    };

    // 4. 페이지 로드 완료 후 실행
    document.addEventListener('DOMContentLoaded', function() {
        // FullCalendar 초기화
        var calendarEl = document.getElementById('mini-calendar');
        if (calendarEl && typeof FullCalendar !== 'undefined') {
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                height: '100%',
                headerToolbar: { left: 'prev,next', center: 'title', right: '' }
            });
            calendar.render();
            setTimeout(() => { 
                calendar.updateSize(); 
            }, 200);
        }

        // 폼 제출 이벤트 (통합 버전)
        const clientRegForm = document.getElementById('clientRegForm');
        if (clientRegForm) {
            clientRegForm.addEventListener('submit', function(e) {
                e.preventDefault(); 

                const formData = new FormData(this);

                fetch('/register_client/', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        location.reload(); 
                    } else {
                        alert("등록 실패: " + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("서버 연결에 실패했습니다.");
                });
            });
        }        
    });


function search_clients() {
    var keyword = $('#search_keyword').val();
    
    $.ajax({
        url: '/search_clients/',
        type: 'GET',
        data: { 'keyword': keyword },
        success: function(response) {
            if (response.status === 'success') {
                var html = '';
                var data = response.data;

                if (data && data.length > 0) {
                    // 1. [그룹화 로직] 이름+전화번호 기준
                    var grouped = {};
                    for (var i = 0; i < data.length; i++) {
                        var item = data[i];
                        // 이름과 번호가 같으면 하나로 묶기 위한 Key 생성
                        var key = (item.reg_name || "무명") + "_" + (item.reg_phone || "0000").replace(/-/g, '');
                        
                        if (!grouped[key]) {
                            grouped[key] = {
                                name: item.reg_name,
                                phone: item.reg_phone,
                                email: item.reg_email || '',
                                projects: []
                            };
                        }
                        grouped[key].projects.push(item);
                    }

                    // 2. [HTML 생성] 따옴표 에러 방지를 위해 문자열 합치기 사용
                    for (var k in grouped) {
                        var client = grouped[k];
                        // 이메일 기호 처리
                        var emailRaw = client.email ? client.email : "";

                        html += '<div class="contact-card mb-2 shadow-sm"...>';
                        html +=   '<div class="d-flex...">';
                        html +=     '<div>';
                        // ★ 성함에 class="info-name-source" 추가
                        html +=       '<span class="fw-bold info-name-source" style="font-size: 1.1rem;">' + client.name + '</span>';
                        html +=       '<div class="text-muted small">';
                        // ★ 전화번호에 class="info-phone-source" 추가
                        html +=         '<i class="bi bi-telephone"></i> <span class="info-phone-source">' + client.phone + '</span>';
                        // ★ 이메일에 class="info-email-source" 추가
                        html +=         ' | <span class="info-email-source">' + emailRaw + '</span>';
                        html +=       '</div>';
                        html +=     '</div>';

                        // 해당 고객에게 속한 모든 현장(프로젝트) 나열
                        for (var j = 0; j < client.projects.length; j++) {
                            var p = client.projects[j];
                            
                            // search_clients 함수 내부, html 만드는 곳 바로 위
                            // console.log("--------------------------------------");
                            // console.log("현장명(p.reg_project_name):", p.reg_project_name);
                            // console.log("성함(client.name):", client.name);  // <--- 여기가 비어있을 확률 높음
                            // console.log("번호(client.phone):", client.phone);
                            // console.log("이메일(client.email):", client.email);
                            // console.log("--------------------------------------");
                            
                            // 백틱 대신 일반 따옴표를 사용하여 onclick 인자 전달 (가장 안전한 방식)
                            html += '<div class="mt-1 small ps-2 border-start border-primary text-primary" style="cursor:pointer;" ';
                            html += ' onclick="load_financial_report(\'' + p.reg_project_name + '\', \'' + p.id + '\', \'' + client.name + '\', \'' + client.phone + '\', \'' + client.email + '\')">';
                            html += '  └ [' + p.reg_company + '] ' + p.reg_project_name;
                            html += '</div>';
                        }

                        html +=   '</div>';
                        html += '</div>';
                    }
                } else {
                    html = '<div class="p-3 text-center text-muted">검색 결과가 없습니다.</div>';
                }
                $('#client_list').html(html);
            }
        },
        error: function() {
            alert("조회 중 오류가 발생했습니다.");
        }
    });
}

// ---------------------------위 코드 1시15분 까지 정상작동 되던 코드임----------

function load_financial_report(projectName, clientId, name, phone,email) {
    // 1. 전역 변수 및 화면 텍스트 업데이트
    tempClientData.projectName = projectName;
    tempClientData.clientId = clientId;
    tempClientData.name = name;
    tempClientData.phone = phone;
    tempClientData.email = email || '';
    
    
    currentClientId = clientId; 
    
    $('#info_name').text(name); 
    $('#info_phone').text(phone);
    $('#selected_project_name').text(projectName); 
    $('#current_project_title').text(projectName); 

    // 2. 로딩 표시
    $('#project_detail_list').html('<tr><td colspan="9" class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary"></div> 데이터를 불러오는 중...</td></tr>');
    $('#memo_history_area').html('<div class="text-center p-3"><div class="spinner-border spinner-border-sm text-secondary"></div></div>');

    // 3. [AJAX 1] MSSQL에서 정산/현장 데이터 불러오기
    $.ajax({
        url: '/get_project_full_details/',
        type: 'GET',
        data: { 
            'project_name': projectName,
            'client_id': clientId 
        },
        success: function(response) {
            if (response.status === 'success') {
                let html = '';
                if (response.data && response.data.length > 0) {
                    response.data.forEach(function(row) {
                        const supplyValue = row.supply_value ? Number(row.supply_value).toLocaleString() : '0';
                        const depositValue = row.deposit ? Number(row.deposit).toLocaleString() : '0';

                        html += `
                            <tr>
                                <td class="text-center">${row.request_code || '-'}</td>
                                <td class="text-center">${row.receipt_code || '-'}</td>
                                <td class="text-center">${row.save_date || '-'}</td>
                                <td>${row.specimen || '-'}</td>
                                <td class="text-end fw-bold">${supplyValue}</td>
                                <td class="text-center">${row.deposit_day || '-'}</td>
                                <td class="text-end text-success fw-bold">${depositValue}</td>
                                <td>${row.company || '-'}</td>
                                <td class="text-center">${row.issue_date || '-'}</td>
                            </tr>`;
                    });
                } else {
                    html = '<tr><td colspan="9" class="text-center py-4 text-muted">해당 현장의 정산 내역이 없습니다.</td></tr>';
                }
                $('#project_detail_list').html(html);
            }
        },
        error: function() {
            $('#project_detail_list').html('<tr><td colspan="9" class="text-center py-4 text-danger">서버 통신 실패</td></tr>');
        }
    });

    // 4. [AJAX 2] 과거 상담 히스토리 불러오기 (함수 내부로 포함시켰습니다!)
    $.ajax({
    url: '/get_consulting_history/',
    type: 'GET',
    data: { 'client_id': clientId },
    success: function(response) {
        if (response.status === 'success') {
            let html = '';
            if (response.data && response.data.length > 0) {
                response.data.forEach(function(memo) {
                    let badgeClass = 'bg-secondary'; 
                    if(memo.category === '시험예약') badgeClass = 'bg-success';
                    else if(memo.category === '세발예약') badgeClass = 'bg-warning text-dark';
                    else if(memo.category === '견적예약') badgeClass = 'bg-info text-dark';
                    else if(memo.category === '입찰예약') badgeClass = 'bg-dark';

                    html += `
                        <div class="card mb-2 shadow-sm" id="memo-card-${memo.id}">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <div>
                                        <span class="badge ${badgeClass}">${memo.category}</span>
                                        <small class="text-muted ms-1">${memo.date}</small>
                                    </div>
                                    <div class="btn-group">
                                        <button class="btn btn-link p-0 me-2 text-primary" onclick="editMemo('${memo.id}')" title="수정">
                                            <i class="bi bi-pencil-square" style="font-size: 0.85rem;"></i>
                                        </button>
                                        <button class="btn btn-link p-0 text-danger" onclick="deleteMemo('${memo.id}')" title="삭제">
                                            <i class="bi bi-trash" style="font-size: 0.85rem;"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-text small text-dark" id="memo-content-${memo.id}">
                                    ${memo.content.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        </div>`;
                });
            } else {
                html = '<div class="text-center text-muted small p-3">과거 상담 내역이 없습니다.</div>';
            }
            $('#memo_history_area').html(html); 
        }
    }
});
}

// 메모 저장 함수
// 3. 버튼 클릭 이벤트 (반드시 $(document).ready 안에 넣거나 스크립트 하단에 배치)
$(document).on('click', '.memo-save-btn', function() {
    const category = $(this).data('category');
    const content = $('#memo_content').val();
    const projectName = $('#selected_project_name').text();

    if (!currentClientId) {
        alert("먼저 왼쪽 리스트에서 담당자를 선택해 주세요.");
        return;
    }

    $.ajax({
        url: '/save_consulting_memo/',
        type: 'POST',
        data: {
            'client_id': currentClientId,
            'project_name': projectName,
            'category': category,
            'content': content,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.status === 'success') {
                alert(category + " 저장 및 예약 등록 완료!");
                $('#memo_content').val(''); // 입력창 비우기

                // 모든 UI 구성요소 동시 갱신
                load_financial_report(projectName, currentClientId); // 1. 히스토리 & 캘린더 리프레시 포함
                
                if (typeof load_active_tasks === 'function') {
                    load_active_tasks(); // 2. 우측 업무 리스트 갱신
                }

                if (typeof calendar !== 'undefined' && calendar !== null) {
                    calendar.refetchEvents(); // 3. 캘린더 이벤트 갱신 (혹시 모르니 한 번 더 호출)
                }
            } else {
                alert("저장 실패: " + response.message);
            }
        },
        error: function(xhr) {
            alert("서버 통신 에러가 발생했습니다.");
        }
    });
});

// 페이지 로드 완료 시 실행

$(document).ready(function() {
    // 1. 우측 업무 예약 리스트 처음 불러오기
    if (typeof load_active_tasks === 'function') {
        load_active_tasks();
    }

    // 2. 하단 캘린더 초기화 로직
    var calendarEl = document.getElementById('calendar'); // HTML의 ID와 일치해야 함
    if (calendarEl) {
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: ''
            },
            height: '100%',
            events: '/get_calendar_events/', // 서버에서 데이터를 가져올 주소
            eventDidMount: function(info) {
                // 마우스를 올리면 상세 내용이 보이게 툴팁 추가 (선택사항)
                info.el.title = info.event.title;
            }
        });
        calendar.render();
    } else {
        console.error("ID가 'calendar'인 엘리먼트를 찾지 못했습니다. HTML 코드를 확인해주세요.");
    }
});


function load_active_tasks() {
    $.ajax({
        url: '/get_active_tasks/',
        type: 'GET',
        success: function(response) {
            if (response.status === 'success') {
                let html = '';
                if (response.data && response.data.length > 0) {
                    response.data.forEach(function(task) {
                        // 완료 여부에 따른 스타일 설정
                        const isDone = task.is_completed === 1;
                        const textStyle = isDone ? 'text-decoration: line-through; color: #adb5bd;' : '';
                        const cardOpacity = isDone ? 'opacity: 0.7; background-color: #f1f3f5;' : 'background-color: #f8f9fa;';
                        // const badgeClass = isDone ? 'bg-secondary' : (task.category === '시험예약' ? 'bg-success' : 'bg-primary');
                        // --- 배지 색상 통일 로직 시작 ---
                        let badgeClass = 'bg-primary';
                        if (isDone) {
                            badgeClass = 'bg-secondary';
                        } else {
                            if (task.category === '시험예약') badgeClass = 'bg-success';
                            else if (task.category === '세발예약') badgeClass = 'bg-warning text-dark';
                            else if (task.category === '견적예약') badgeClass = 'bg-info text-dark';
                            else if (task.category === '입찰예약') badgeClass = 'bg-dark';
                            else if (task.category === '일반예약') badgeClass = 'bg-secondary';
                        }
                        // --- 배지 색상 통일 로직 끝 ---
                        html += `
                            <div class="card mb-2 shadow-sm border-0" style="${cardOpacity}">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="badge ${badgeClass}" style="font-size: 0.65rem;">${task.category}</span>
                                        <div class="d-flex align-items-center gap-1">
                                            <small class="text-muted" style="font-size: 0.65rem;">${task.start_date || ''}</small>
                                            ${!isDone ? `
                                                <button class="btn btn-sm btn-light p-0 px-1" style="font-size: 0.7rem; border: 1px solid #ddd;" 
                                                        onclick="completeTask(${task.id})">
                                                    <i class="bi bi-check-lg text-success"></i>
                                                </button>` : '<i class="bi bi-check-all text-muted"></i>'}
                                        </div>
                                    </div>
                                    <div class="fw-bold small text-truncate" style="${textStyle}">${task.project_name}</div>
                                    <div class="mt-1" style="font-size: 0.75rem; line-height: 1.2; ${textStyle}">
                                        ${task.content}
                                    </div>
                                </div>
                            </div>`;
                    });
                } else {
                    html = '<div class="text-center text-muted small p-3">등록된 업무가 없습니다.</div>';
                }
                $('#task_list_area').html(html);
            }
        }
    });
}

function completeTask(taskId) {
    if (!confirm("업무를 완료하시겠습니까?")) return;

    $.ajax({
        url: '/complete_task/',
        type: 'POST',
        data: {
            'task_id': taskId,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.status === 'success') {
                load_active_tasks(); // 성공하면 리스트 갱신
            }
        }
    });
}


// ------------------------폴더생성관리---------------------str
function manageFolder(actionType) {
    // 화면에 써진 글자를 직접 읽어옵니다.
    const name = $('#info_name').text().trim();
    const phone = $('#info_phone').text().trim();
    const projectName = $('#current_project_title').text().trim();

    const folderData = {
        'client_id': currentClientId, 
        'name': name,
        'phone': phone,
        'project_name': projectName,
        'action': actionType,
        'csrfmiddlewaretoken': '{{ csrf_token }}'
    };

    console.log("보내는 데이터:", folderData); // 디버깅용

    // 방어 코드: 정보가 하나라도 없으면 중단
    if (!name || name === "" || projectName === "프로젝트를 선택해주세요") {
        alert("담당자 정보 또는 프로젝트가 선택되지 않았습니다.");
        return;
    }

    if (actionType === 'create') {
        if (!confirm(`[${projectName}]\n폴더를 생성하시겠습니까?`)) return;
    }

    $.ajax({
        url: '/manage_folder/', 
        type: 'POST',
        data: folderData,
        success: function(res) {
            if (res.status === 'success') {
                if (actionType === 'create') alert(res.message);
                // actionType이 'open'인 경우 서버에서 os.startfile을 실행하므로 
                // 별도의 alert 없이 창이 뜨면 성공입니다.
            } else {
                alert(res.message);
            }
        },
        error: function() {
            alert("서버 통신 중 오류가 발생했습니다.");
        }
    });
}

// -----------------------메모수정삭제------------------
// 1. 메모 수정 모드 전환
// 1. 메모 수정 모드 (텍스트 영역을 입력창으로 교체)
function editMemo(memoId) {
    const contentDiv = $(`#memo-content-${memoId}`);
    // br 태그를 다시 줄바꿈 문자로 변경하여 편집창에 넣음
    const currentText = contentDiv.html().replace(/<br\s*[\/]?>/gi, '\n').trim();
    
    const inputHtml = `
        <textarea id="edit-area-${memoId}" class="form-control form-control-sm mb-1" rows="3" style="font-size: 0.8rem;">${currentText}</textarea>
        <div class="text-end">
            <button class="btn btn-xs btn-primary py-0" onclick="updateMemo('${memoId}')">저장</button>
            <button class="btn btn-xs btn-light py-0 border" onclick="cancelEdit('${memoId}')">취소</button>
        </div>
    `;
    contentDiv.html(inputHtml);
}

// 2. 수정 취소 (데이터 다시 로드)
function cancelEdit(memoId) {
    load_financial_report($('#selected_project_name').text(), currentClientId, $('#info_name').text(), $('#info_phone').text());
}

// 3. 메모 수정 실행 (서버 전송)
function updateMemo(memoId) {
    const newContent = $(`#edit-area-${memoId}`).val();

    $.ajax({
        url: '/update_memo/',
        type: 'POST',
        data: {
            'memo_id': memoId,
            'content': newContent,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(res) {
            if (res.status === 'success') {
                // 1. 왼쪽 상담 히스토리 갱신
                load_financial_report(
                    $('#selected_project_name').text(), 
                    currentClientId, 
                    $('#info_name').text(), 
                    $('#info_phone').text()
                );
                
                // 2. ★ 사용자님의 실제 함수명인 load_active_tasks()로 연결 ★
                // DB 반영 시간을 위해 살짝 지연 실행합니다.
                setTimeout(function() {
                    if (typeof load_active_tasks === 'function') {
                        load_active_tasks(); // 언더바(_) 확인 완료!
                        console.log("우측 업무 예약 리스트 새로고침 실행됨");
                    }
                    // ★ 카렌더 이벤트 새로고침 추가
                    if (typeof calendar !== 'undefined' && calendar !== null) {
                        calendar.refetchEvents(); 
                        console.log("카렌더 동기화 완료");
                    }
                }, 200); 

                alert("수정되었습니다.");
            } else {
                alert("수정 실패: " + res.message);
            }
        },
        error: function() { 
            alert("서버와 통신 중 오류가 발생했습니다."); 
        }
    });
}

// 4. 메모 삭제 실행
function deleteMemo(memoId) {
    if (!confirm("이 상담 메모를 삭제하시겠습니까?\n연결된 '업무 예약'도 함께 삭제됩니다.")) return;

    $.ajax({
        url: '/delete_memo/',
        type: 'POST',
        data: {
            'memo_id': memoId,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(res) {
            if (res.status === 'success') {
                // 1. 왼쪽 메모 카드 즉시 제거
                $(`#memo-card-${memoId}`).fadeOut(300, function() { 
                    $(this).remove(); 
                });
                
                // 2. 시간차를 두고 우측 리스트와 왼쪽 리포트 전체를 새로고침
                setTimeout(function() {
                    console.log("삭제 후 리스트 갱신 시작...");
                    
                    // 우측 업무 리스트 갱신
                    if (typeof load_active_tasks === 'function') {
                        load_active_tasks();
                    }
                    // ★ 삭제 후 카렌더 동기화 ★
                    if (typeof calendar !== 'undefined' && calendar !== null) {
                        calendar.refetchEvents();
                    }
                    
                    // 왼쪽 전체 리포트 갱신 (전체 카운트 등을 맞추기 위해)
                    load_financial_report(
                        $('#selected_project_name').text(), 
                        currentClientId, 
                        $('#info_name').text(), 
                        $('#info_phone').text()
                    );
                }, 500); // 안전하게 0.5초 대기

            } else {
                alert("삭제 실패: " + res.message);
            }
        },
        error: function() { 
            alert("서버와 통신 중 오류가 발생했습니다."); 
        }
    });
}
</script>
{% endblock %}