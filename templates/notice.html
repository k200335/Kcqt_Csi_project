{% extends "base.html" %}
{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

<style>
.consult-integrated-wrapper {
    display: flex;
    height: calc(100vh - 165px);
    margin: -1rem;
    padding: 15px;
    background-color: #f4f6f9;
    gap: 15px;
    overflow: hidden;
}

.dashboard-card { background: white; border-radius: 10px; border: 1px solid #dee2e6; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 100%; }
.sidebar-left { width: 320px; flex-shrink: 0; }
.main-consult-area { flex: 1; min-width: 0; }
.sidebar-right { width: 320px; flex-shrink: 0; }
.scrollable-content { flex: 1; overflow-y: auto; padding: 15px; }

/* 담당자 카드 스타일 */
.contact-card { padding: 12px; border-radius: 8px; background: #f8fafc; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
.contact-card:hover { background: #eef2ff; border-color: #0d6efd; }
.contact-card.active { background: #eef2ff; border-color: #0d6efd; box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.1); }

.btn-register-plus { padding: 0.25rem 0.5rem; line-height: 1; }

    /* 테이블 내부 스크롤바 디자인 */
.table-responsive::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}
.table-responsive::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 4px;
}
.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #999;
}
</style>

<div class="consult-integrated-wrapper">
    <aside class="sidebar-left dashboard-card">
        <div class="p-3 border-bottom bg-light">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="fw-bold mb-0"><i class="bi bi-person-lines-fill me-2"></i>담당자 검색</h6>
                <button type="button" class="btn btn-success btn-sm btn-register-plus" onclick="openRegisterModal()" title="신규 담당자/프로젝트 등록">
                    <i class="bi bi-person-plus-fill"></i>
                </button>
            </div>
            <div class="input-group input-group-sm">
                <input type="text" id="search_keyword" class="form-control" placeholder="성함 또는 업체명..." 
                    onkeyup="if(window.event.keyCode==13){search_clients()}">
                
                <button class="btn btn-primary" type="button" onclick="search_clients()">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>
        <div class="list-group list-group-flush border-bottom scrollarea" id="client_list">
            <div class="p-4 text-center text-muted">
                <i class="bi bi-search d-block mb-2" style="font-size: 2rem;"></i>
                담당자 성함 또는 업체명을 검색해주세요.
            </div>
        </div>
    </aside>

    <main class="main-consult-area d-flex flex-column gap-3">
        <div class="dashboard-card p-3" style="height: auto;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="fw-bold mb-0 text-truncate" id="display_project_name">프로젝트를 선택해주세요</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-dark"><i class="bi bi-folder2-open"></i> 폴더열기</button>
                    <button class="btn btn-sm btn-primary"><i class="bi bi-save"></i> 전체저장</button>
                </div>
            </div>
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-white">
                    <h6 class="m-0 font-weight-bold text-primary" id="selected_project_name">상세 내역 리스트</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6;">
                        <table class="table table-bordered table-sm table-hover mb-0" style="min-width: 1200px; font-size: 0.75rem;">
                            <thead class="table-dark sticky-top">
                                <tr class="text-center">
                                    <th>의뢰번호</th>
                                    <th>QT번호</th>
                                    <th>접수일</th>
                                    <th>봉인명</th>
                                    <th>공급가액</th>
                                    <th>입금일</th>
                                    <th>입금액</th>
                                    <th>계산서발행업체</th>
                                    <th>계산서발행일</th>
                                </tr>
                            </thead>
                            <tbody id="project_detail_list">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-card flex-grow-1 overflow-hidden">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                <h6 class="fw-bold mb-0 text-primary"><i class="bi bi-chat-left-text-fill me-2"></i>실시간 상담 및 업무 메모</h6>
                <div class="d-flex gap-1">
                    <button class="btn btn-xs btn-info text-white">견적예약</button>
                    <button class="btn btn-xs btn-warning text-white">세발예약</button>
                    <button class="btn btn-xs btn-success">시험예약</button>
                </div>
            </div>
            <div class="p-3 border-bottom bg-light">
                <textarea class="form-control form-control-sm" rows="3" placeholder="통화 내용을 기록하세요..."></textarea>
            </div>
            <div class="scrollable-content">
                <h6 class="fw-bold small mb-3 text-muted">과거 상담 히스토리</h6>
            </div>
        </div>
    </main>

    <aside class="sidebar-right d-flex flex-column gap-3">
        <div class="dashboard-card flex-grow-1 overflow-hidden">
            <div class="p-3 border-bottom bg-danger bg-opacity-10">
                <h6 class="fw-bold mb-0 text-danger small"><i class="bi bi-clock-history me-2"></i>업무 예약 (D-Day 관리)</h6>
            </div>
            <div class="scrollable-content"></div>
        </div>
        <div class="dashboard-card p-2" style="height: 320px;">
            <div id="mini-calendar"></div>
        </div>
    </aside>
</div>

<div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white py-2">
                <h6 class="modal-title fw-bold small"><i class="bi bi-person-plus-fill me-2"></i>신규 담당자 및 프로젝트 등록</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="clientRegForm">
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label small fw-bold">담당자 성함</label>
                            <input type="text" class="form-control form-control-sm" name="reg_name" required placeholder="예: 김철수">
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold">연락처 (Unique)</label>
                            <input type="text" class="form-control form-control-sm" name="reg_phone" required placeholder="010-0000-0000">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">이메일 주소</label>
                        <input type="email" class="form-control form-control-sm" name="reg_email" placeholder="example@email.com">
                    </div>

                    <div class="p-3 bg-light rounded-3 mb-3 border">
                        <h6 class="fw-bold small mb-3 text-primary"><i class="bi bi-link-45deg me-1"></i>MSSQL 프로젝트 연결</h6>
                        <div class="mb-3">
                            <label for="reg_company" class="form-label">시공사/발주처</label>
                            <input type="text" id="reg_company" name="reg_company" class="form-control" placeholder="사업명 확인 시 자동 입력됩니다">
                        </div>
                        <div class="mb-0">
                            <label for="reg_project_name" class="form-label">사업명</label>
                            <div class="input-group input-group-sm">
                                <input type="text" id="reg_project_name" name="reg_project_name" class="form-control" placeholder="사업명을 입력하세요">
                                <button type="button" class="btn btn-secondary" onclick="checkProject()">확인</button>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success btn-sm w-100 fw-bold py-2">데이터베이스에 저장</button>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
    // 1. 모달 열기 함수
    window.openRegisterModal = function() {
        const modalEl = document.getElementById('registerModal');
        if (modalEl) {
            if (typeof bootstrap !== 'undefined') {
                const myModal = new bootstrap.Modal(modalEl);
                myModal.show();
            } else {
                alert("Bootstrap 라이브러리 로딩 중입니다. 잠시 후 다시 시도해주세요.");
            }
        }
    };

    // 2. [사업명 확인] 버튼 클릭 시 MSSQL 데이터 조회
    // HTML 버튼의 onclick="checkMsProject()"를 "checkProject()"로 바꾸거나 아래 이름을 맞춤
    window.checkProject = function() {
        const projectName = document.getElementById('reg_project_name').value;
        const companyInput = document.getElementById('reg_company');
        const resultArea = document.getElementById('check_result');

        if (!projectName) {
            alert("사업명을 입력해주세요.");
            return;
        }

        if (resultArea) resultArea.innerHTML = '<span class="text-muted small">조회 중...</span>';

        fetch(`/get_project_detail/?project_name=${encodeURIComponent(projectName)}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // DB에 정보가 있는 경우
                if (companyInput) {
                    companyInput.value = data.builder;
                    companyInput.style.backgroundColor = "#e8f0fe";
                }
                if (resultArea) {
                    resultArea.innerHTML = `<span class="text-primary fw-bold"><i class="bi bi-check-circle"></i> 확인됨 (시공사: ${data.builder})</span>`;
                }
                alert(`현장 정보 확인: 시공사는 [${data.builder}]입니다.`);
            } else if (data.status === 'empty') {
                // 신규 현장인 경우
                if (companyInput) {
                    companyInput.value = "";
                    companyInput.focus();
                    companyInput.style.backgroundColor = "#ffffff";
                }
                if (resultArea) {
                    resultArea.innerHTML = `<span class="text-warning fw-bold"><i class="bi bi-exclamation-triangle"></i> 신규 현장 (직접 입력 가능)</span>`;
                }
                alert("신규 현장입니다. 시공사/발주처를 직접 입력해주세요.");
            } else {
                alert("에러 발생: " + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("서버 통신 중 오류가 발생했습니다.");
        });
    };

    // 3. 사이드바 항목 클릭 시 메인 화면에 정보 표시 (테스트용 데이터 유지)
    window.selectProject = function(reqNo) {
        const reqNoDisplay = document.getElementById('ms_req_no');
        const nameDisplay = document.getElementById('display_project_name');
        
        if (reqNoDisplay) reqNoDisplay.innerText = reqNo;
        
        if (nameDisplay) {
            if (reqNo === 'QT26-001') {
                nameDisplay.innerText = "[GS건설] A아파트 신축공사";
            } else {
                nameDisplay.innerText = "[두산건설] B아파트 신축공사";
            }
        }
    };

    // 4. 페이지 로드 완료 후 실행
    document.addEventListener('DOMContentLoaded', function() {
        // FullCalendar 초기화
        var calendarEl = document.getElementById('mini-calendar');
        if (calendarEl && typeof FullCalendar !== 'undefined') {
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                height: '100%',
                headerToolbar: { left: 'prev,next', center: 'title', right: '' }
            });
            calendar.render();
        }

        // 폼 제출 이벤트 (통합 버전)
        const clientRegForm = document.getElementById('clientRegForm');
        if (clientRegForm) {
            clientRegForm.addEventListener('submit', function(e) {
                e.preventDefault(); 

                const formData = new FormData(this);

                fetch('/register_client/', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        location.reload(); 
                    } else {
                        alert("등록 실패: " + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("서버 연결에 실패했습니다.");
                });
            });
        }        
    });

function search_clients() {
    const keyword = $('#search_keyword').val();
    
    $.ajax({
        url: '/search_clients/',
        type: 'GET',
        data: { 'keyword': keyword },
        success: function(response) {
            if (response.status === 'success') {
                let html = '';
                if (response.data.length > 0) {
                    response.data.forEach(function(item) {
                        // 클릭 시 상세 정보를 불러오도록 onclick 이벤트 연결
                        html += `
                        <div class="contact-card mb-2" style="cursor:pointer;" onclick="load_financial_report('${item.reg_project_name}')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <span class="fw-bold">${item.reg_name}</span>
                                    <div class="text-muted small">${item.reg_phone}</div>
                                </div>
                            </div>
                            <div class="mt-2 small ps-2 border-start text-primary">
                                └ [${item.reg_company}] ${item.reg_project_name}
                            </div>
                        </div>
                    `;
                });
                } else {
                    html = '<div class="p-3 text-center">검색 결과가 없습니다.</div>';
                }
                // 왼쪽 리스트 영역의 ID가 'client_list'라고 가정
                $('#client_list').html(html);
            }
        }
    });
}

function load_financial_report(projectName) {
    $('#selected_project_name').text(projectName); // 상단 제목 업데이트
    
    $.ajax({
        url: '/get_project_full_details/',
        type: 'GET',
        data: { 'project_name': projectName },
        success: function(response) {
            if (response.status === 'success') {
                let html = '';
                if (response.data.length > 0) {
                    response.data.forEach(function(row) {
                        html += `
                            <tr>
                                <td>${row.request_code || '-'}</td>
                                <td>${row.receipt_code || '-'}</td>
                                <td>${row.save_date || '-'}</td>
                                <td>${row.specimen || '-'}</td>
                                <td class="text-end fw-bold">${Number(row.supply_value).toLocaleString()}</td>
                                <td>${row.deposit_day || '-'}</td>
                                <td class="text-end text-success">${Number(row.deposit).toLocaleString()}</td>
                                <td>${row.company || '-'}</td>
                                <td>${row.issue_date || '-'}</td>
                            </tr>`;
                    });
                } else {
                    html = '<tr><td colspan="9" class="text-center py-4">해당 현장의 데이터를 찾을 수 없습니다.</td></tr>';
                }
                $('#project_detail_list').html(html);
            }
        }
    });
}
</script>
{% endblock %}