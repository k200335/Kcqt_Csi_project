{% extends "base.html" %}
{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/styles/ag-theme-balham.css">
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.1/dist/ag-grid-community.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
    /* 1. 상하 6:4 분할 레이아웃 */
    #main-layout {
        display: flex;
        flex-direction: column;
        height: 92vh; /* 전체 화면 높이 확보 */
        gap: 10px;
        padding: 10px;
    }

    /* 상단 영역 (6) */
    .top-section {
        flex: 6; 
        display: flex;
        flex-direction: column;
        min-height: 0; /* flex 자식의 overflow 방지 */
    }

    /* 하단 영역 (4) */
    .bottom-section {
        flex: 4;
        background-color: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        overflow-y: auto;
    }

    /* 검색 바 스타일 */
    .search-bar {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-bottom: 8px;
    }

    /* 그리드 컨테이너 */
    #myGrid {
        flex: 1;
        width: 100%;
    }

    .fw-bold-small { font-weight: bold; font-size: 0.85rem; }
</style>

<div id="main-layout">
    <div class="top-section">
        <div class="search-bar">
            <select id="dateTarget" class="form-select form-select-sm" style="width: 130px;">
                <option value="deposit">입금일 기준</option>
                <option value="receipt">실접수일 기준</option>
            </select>

            <div class="d-flex align-items-center gap-1">
                <input type="date" id="startDate" class="form-control form-control-sm" style="width: 140px;">
                <span>~</span>
                <input type="date" id="endDate" class="form-control form-control-sm" style="width: 140px;">
            </div>

            <select id="searchType" class="form-select form-select-sm" style="width: 120px;">                
                <option value="req_no">의뢰번호</option>
                <option value="receipt_no">QT번호</option>                
                <option value="client">의뢰기관명</option>
                <option value="project">사업명</option>
            </select>

            <input type="text" id="searchText" class="form-control form-control-sm" style="width: 180px;" placeholder="검색어 입력">

            <button onclick="onSearch()" class="btn btn-primary btn-sm px-3">
                <i class="bi bi-search"></i> 조회
            </button>
            <button onclick="onExcelDownload()" class="btn btn-outline-success btn-sm px-3">
                <i class="bi bi-file-earmark-excel"></i> 엑셀 다운로드
            </button>
            <div class="d-flex align-items-center ms-auto gap-3 px-3 py-1 bg-white border rounded shadow-sm" style="min-width: 500px;">
                <div class="text-nowrap"><span class="small text-muted">총:</span> <b id="stat-count" class="text-dark">0</b><span class="small">건</span></div>
                <div class="vr"></div>
                <div class="text-nowrap"><span class="small text-muted">공급가:</span> <b id="stat-supply" class="text-primary">0</b></div>
                <div class="vr"></div>
                <div class="text-nowrap"><span class="small text-muted">부가세:</span> <b id="stat-vat" class="text-secondary">0</b></div>
                <div class="vr"></div>
                <div class="text-nowrap"><span class="small text-muted">합계:</span> <b id="stat-total" class="text-danger">0</b></div>
                <div class="vr"></div>
                <div class="text-nowrap"><span class="small text-muted">입금액:</span> <b id="stat-deposit" class="text-success">0</b></div>
            </div>
        </div>

        <div id="myGrid" class="ag-theme-balham"></div>
    </div>

    <div class="bottom-section">
        <h6 class="fw-bold-small border-bottom pb-2 mb-3">
            <i class="bi bi-info-circle"></i> 상세 정보 및 통계
        </h6>
        <div id="detail-content" class="text-muted text-center mt-5">
            그리드에서 행을 선택하거나 조회를 시작하세요.
        </div>
    </div>
</div>

<script>
    let gridApi;

    // 1. 칼럼 정의 (요청하신 4개 항목 위주)
    const columnDefs = [
        { headerName: "담당자", field: "담당자", width: 60, pinned: 'left' },
        // { headerName: "미인정", field: "미인정", width: 80, pinned: 'left', valueFormatter: p => p.value == '1' ? '미인정' : '인정' },       
        { headerName: "미인정", field: "미인정", width: 60, pinned: 'left',
            // 값이 존재하고 '0'이 아니면 DB 값 그대로, 그 외엔 하이픈(-)
            valueFormatter: p => {
                if (p.value != null && p.value !== "" && p.value != '0') {
                    return p.value; // DB에 저장된 값 (예: 1, 2 등) 그대로 출력
                }
                return "-"; // 값이 없거나 0일 때만 하이픈
            },
            cellStyle: { 'text-align': 'center' }
        },        
        { headerName: "의뢰번호", field: "의뢰번호", width: 150, pinned: 'left' },
        { headerName: "지원", field: "지원", width: 80 },
        { headerName: "영업담당", field: "영업담당", width: 100 },
        { headerName: "QT번호", field: "QT번호", width: 140 },
        { headerName: "실접수일", field: "실접수일", width: 120, valueFormatter: p => p.value ? p.value.split('T')[0] : "" },
        { headerName: "의뢰기관명", field: "의뢰기관명", width: 220,
            cellStyle: params => {
                // 강조할 의뢰기관(건설사) 목록
                const companies = [
                    "현대엔지니어링", "두산건설", "두산중공업", "GS건설", "지에스건설", "극동건설", "금광기업", 
                    "남광토건", "대우건설","포스코", "가나개발", "케이티에이", "현대건설", 
                    "현대 건설", "롯데 건설", "롯데건설", "대방건설", "쌍용건설"
                ];

                if (params.value) {
                    // 목록 중 하나라도 포함되어 있는지 확인
                    const isMatch = companies.some(company => params.value.includes(company));
                    if (isMatch) {
                        // 파란색 굵은 글씨 적용
                        return { color: '#0d6efd', fontWeight: 'bold' };
                    }
                }
                return null;
            }
        },
        { headerName: "사업명", field: "사업명", width: 300 },
        { headerName: "봉인명", field: "봉인명", width: 220,
        cellStyle: params => {
                // 강조할 키워드 목록
                const keywords = [
                    "가새재", "가설받침", "수직재", "수평재", "멍에", "장선", "동바리", "비계용", 
                    "강관조인트", "연결조인트", "조립형 비계", "조입철물", "파이프서포", "파이프써포", 
                    "파이프 써포", "파이프 서포", "받침철물", "가설자재", "가세재", "가설재", 
                    "강관 조인", "강관서포", "대각재", "비계파이프", "서포트", "트러스", 
                    "수직제", "수평제", "각형강", "각형 강", "각관", "멍애", "망에", 
                    "작업대", "작업계단", "발판", "클램프", "크램프"
                ];

                // 봉인명 데이터가 있고, 위 키워드 중 하나라도 포함되어 있는지 확인
                if (params.value) {
                    const isMatch = keywords.some(keyword => params.value.includes(keyword));
                    if (isMatch) {
                        // 조건에 맞으면 파란색 굵은 글씨 적용
                        return { color: '#0d6efd', fontWeight: 'bold' };
                    }
                }
                return null; // 조건에 맞지 않으면 기본 스타일
            }  
        },
        { headerName: "시료량", field: "시료량", width: 100 },
        { headerName: "공급가액", field: "공급가액", width: 120, type: 'numericColumn', valueFormatter: p => Math.floor(p.value || 0).toLocaleString() },
        { headerName: "부가세", field: "부가세", width: 110, type: 'numericColumn', valueFormatter: p => Math.floor(p.value || 0).toLocaleString() },
        { headerName: "합계", valueGetter: p => (Number(p.data.공급가액 || 0) + Number(p.data.부가세 || 0)), width: 120, type: 'numericColumn', valueFormatter: p => p.value.toLocaleString() },
        { headerName: "출장비구분", field: "출장비구분", width: 100, valueFormatter: p => p.value == '1' ? "본원" : "지원" },
        { headerName: "출장비", field: "출장비", width: 100, valueFormatter: p => (p.value || 0).toLocaleString() },
        { headerName: "기본료", field: "기본료", width: 100, valueFormatter: p => (p.value || 0).toLocaleString() },
        { headerName: "정보처리비", field: "정보처리비", width: 110, valueFormatter: p => (p.value || 0).toLocaleString() },
        { headerName: "시편제작비", field: "시편제작비", width: 110, valueFormatter: p => (p.value || 0).toLocaleString() },
        { headerName: "지게차운임", field: "지게차운임", width: 110, valueFormatter: p => (p.value || 0).toLocaleString() },
        { headerName: "시료수거비", field: "시료수거비", width: 110 },
        { headerName: "청구위탁시험비", field: "청구위탁시험비", width: 130, valueFormatter: p => (p.value || 0).toLocaleString() },
        { headerName: "적용금액", field: "적용금액", width: 120 },
        { headerName: "인센티브", field: "인센티브", valueFormatter: p => Math.round(p.value || 0).toLocaleString() },
        { headerName: "입금일", field: "입금일", width: 120 },
        { headerName: "입금액", field: "입금액", width: 120, cellStyle: {'background-color': '#e6fffa'}, valueFormatter: p => (p.value || 0).toLocaleString() },
        { headerName: "계산서발행회사명", field: "계산서발행회사명", width: 180 },
        { headerName: "계산서발행일", field: "계산서발행일", width: 120 },
        { headerName: "계산서담당자", field: "계산서담당자", width: 120 },
        { headerName: "계산서hp", field: "계산서hp", width: 130 },
        { headerName: "계산서tel", field: "계산서tel", width: 130 },
        { headerName: "계산서fax", field: "계산서fax", width: 130 },
        { headerName: "계산서email", field: "계산서email", width: 180 },
        { headerName: "계산서발행자", field: "계산서발행자", width: 120 },
        { headerName: "의뢰인성명", field: "의뢰인성명", width: 120 },
        { headerName: "현장전화", field: "현장전화", width: 130 },
        { headerName: "시료채취자", field: "시료채취자", width: 120 },
        { headerName: "품질담당자", field: "품질담당자", width: 120 },
        { headerName: "현장담당", field: "현장담당", width: 100 },
        { headerName: "시료명", field: "시료명", width: 150 },
        { headerName: "공수", field: "공수",  width: 80,
        // type: 'numericColumn' 이 부분은 삭제하거나 주석 처리하세요 (숫자 정렬/계산용이기 때문)
        cellStyle: { 'text-align': 'center' }, // 숫자가 아니므로 가운데 정렬 추천
        valueFormatter: p => p.value === null || p.value === undefined ? "" : p.value 
        // 값이 없으면 빈칸, 있으면 DB에 있는 문자 그대로 출력
        },                       
        { headerName: "지급액합계", field: "지급액합계", width: 120, type: 'numericColumn', valueFormatter: p => Math.floor(p.value || 0).toLocaleString() + "원" }

    ];

    // 2. 그리드 옵션 설정
    const gridOptions = {
        columnDefs: columnDefs,
        rowData: [],
        defaultColDef: {
            resizable: true,
            sortable: true,
            filter: true,
            headerClass: 'text-center'
        },
        headerHeight: 32,
        rowHeight: 28,
        // onRowClicked: (params) => {
        // showDetail(params.data); // 하단에 만들어둔 표 함수를 호출하도록 변경
        // }
        // 행 클릭 시 하단 영역 업데이트 예시
        // onRowClicked: (params) => {
        //     document.getElementById('detail-content').innerHTML = `
        //         <div class="text-start p-3 bg-light rounded border">
        //             <p><b>의뢰번호:</b> ${params.data.의뢰번호}</p>
        //             <p><b>담당자:</b> ${params.data.담당자}</p>
        //             <p><b>공급가액:</b> ${Number(params.data.공급가액).toLocaleString()} 원</p>
        //         </div>
        //     `;
        // }
    };

    // 3. 페이지 초기화
    document.addEventListener('DOMContentLoaded', () => {
        const gridDiv = document.querySelector('#myGrid');
        gridApi = agGrid.createGrid(gridDiv, gridOptions);

        // 기본 날짜 설정 (한달 전 ~ 오늘)
        const today = new Date().toISOString().split('T')[0];
        const lastMonth = new Date();
        lastMonth.setMonth(lastMonth.getMonth() - 1);
        
        document.getElementById('endDate').value = today;
        document.getElementById('startDate').value = lastMonth.toISOString().split('T')[0];
    });


function onSearch() {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    const dateType = document.getElementById('dateTarget').value === 'receipt' ? 'save' : 'deposit';
    const searchType = document.getElementById('searchType').value;
    const searchText = document.getElementById('searchText').value;

    if (!start || !end) {
        alert("조회 기간을 선택해주세요.");
        return;
    }

    gridApi.setGridOption('rowData', []);
    document.getElementById('detail-content').innerHTML = "데이터를 불러오는 중...";

    const url = `/settlement_admin/?start_date=${start}&end_date=${end}&date_type=${dateType}&search_type=${searchType}&search_text=${encodeURIComponent(searchText)}`;
    
    fetch(url)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                alert("에러 발생: " + data.error);
                return;
            }
            gridApi.setGridOption('rowData', data);
            
            // 1. 하단 요약 업데이트 (기존)
            // updateBottomSummary(data);

            // 2. 상단 요약 업데이트 (신규 추가)
            updateTopSummary(data);
        })
        .catch(err => {
            console.error("데이터 로드 실패:", err);
            alert("데이터를 가져오는 중 오류가 발생했습니다.");
        });
}

// 상단 통계 업데이트 함수
function updateTopSummary(data) {
    const count = data.length;
    const supply = data.reduce((sum, r) => sum + Number(r.공급가액 || 0), 0);
    const vat = data.reduce((sum, r) => sum + Number(r.부가세 || 0), 0);
    const deposit = data.reduce((sum, r) => sum + Number(r.입금액 || 0), 0);
    const total = supply + vat;

    // 각 ID에 맞는 위치에 숫자 삽입 (콤마 추가)
    document.getElementById('stat-count').innerText = count.toLocaleString();
    document.getElementById('stat-supply').innerText = Math.floor(supply).toLocaleString();
    document.getElementById('stat-vat').innerText = Math.floor(vat).toLocaleString();
    document.getElementById('stat-total').innerText = Math.floor(total).toLocaleString();
    document.getElementById('stat-deposit').innerText = Math.floor(deposit).toLocaleString();
}

// 엑셀 다운로드 함수
async function onExcelDownload() {
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('정산보고서');

    worksheet.properties.defaultRowHeight = 24.75;

    // 1. 틀고정
    worksheet.views = [
        { 
            state: 'frozen', 
            xSplit: 6, // F열까지 고정
            ySplit: 1  // 첫 번째 행 고정
        }
    ];

    const headers = [
        "담당자", "미인정", "의뢰번호", "지원", "영업담당", "QT번호", "실접수일", 
        "의뢰기관명", "사업명", "봉인명", "시료량", "공급가액", "부가세", "합계", 
        "출장비구분", "출장비", "기본료", "정보처리비", "시편제작비", "지게차운임", 
        "시료수거비", "청구위탁시험비", "적용금액", "인센티브", "입금일", "입금액", 
        "계산서발행회사명", "계산서발행일", "계산서담당자", "계산서hp", "계산서tel", 
        "계산서fax", "계산서email", "계산서발행자", "의뢰인성명", "현장전화", 
        "시료채취자", "품질담당자", "현장담당", "시료명", "공수", "지급액합계"
    ];

    const colWidths = [
        6, 6, 14, 6, 8, 10, 10, 30, 60, 30, 18, 13, 9, 13, 9, 9, 9, 9, 9, 9, 9, 9, 15, 12, 12, 15, 20, 15, 12, 15, 15, 15, 20, 12, 12, 15, 12, 12, 12, 20, 10, 15
    ];

    // 금액 컬럼 리스트 (L=12, M=13, N=14, P=16, Q=17, R=18, S=19, T=20, U=21, V=22, W=23, X=24, Z=26, AP=42)
    const moneyCols = ['L', 'M', 'N', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Z', 'AP'];

    // 컬럼 설정
    worksheet.columns = headers.map((h, i) => {
        const colLetter = worksheet.getColumn(i + 1).letter;
        const isExceptCol = ['H', 'I', 'J', 'AA'].includes(colLetter);
        const isMoneyCol = moneyCols.includes(colLetter); // 금액 컬럼 여부
        
        return {
            header: h,
            key: h,
            width: colWidths[i] || 15,
            style: { 
                font: { size: 10 },
                alignment: { 
                    vertical: 'middle', 
                    // 금액 컬럼은 오른쪽, 제외 컬럼은 왼쪽, 나머지는 가운데
                    horizontal: isMoneyCol ? 'right' : (isExceptCol ? 'left' : 'center'),
                    wrapText: isExceptCol 
                } 
            }
        };
    });

    // 헤더 행 스타일
    const headerRow = worksheet.getRow(1);
    headerRow.height = 24.75;
    headerRow.eachCell((cell) => {
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9EAD3' } };
        cell.font = { bold: true, size: 10 };
        cell.alignment = { vertical: 'middle', horizontal: 'center' };
        cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
    });

    const rowData = [];
    gridApi.forEachNodeAfterFilterAndSort(node => rowData.push(node.data));
    const groupedData = rowData.reduce((acc, obj) => {
        const key = obj['사업명'] || '미지정';
        if (!acc[key]) acc[key] = [];
        acc[key].push(obj);
        return acc;
    }, {});

    const blueKeywords = ["현대", "두산", "GS", "지에스", "극동", "금광", "남광", "대우", "포스코", "가나개발", "케이티에이", "롯데", "대방", "쌍용", "가새재", "가설", "동바리", "비계", "파이프", "서포"];

    let currentRow = 2;
    Object.keys(groupedData).forEach(project => {
        const startRow = currentRow;
        
        groupedData[project].forEach(data => {
            const row = worksheet.addRow([
                data['담당자'], data['미인정'], data['의뢰번호'], data['지원'], data['영업담당'], 
                data['QT번호'], (data['실접수일'] || "").split('T')[0], data['의뢰기관명'], 
                data['사업명'], data['봉인명'], data['시료량'],
                Number(data['공급가액'] || 0), Number(data['부가세'] || 0), 0,
                data['출장비구분'] == '1' ? "본원" : "지원",
                Number(data['출장비'] || 0), Number(data['기본료'] || 0), Number(data['정보처리비'] || 0), 
                Number(data['시편제작비'] || 0), Number(data['지게차운임'] || 0), Number(data['시료수거비'] || 0), 
                Number(data['청구위탁시험비'] || 0), 0,
                Number(data['인센티브'] || 0), data['입금일'], Number(data['입금액'] || 0),
                data['계산서발행회사명'], data['계산서발행일'], data['계산서담당자'], data['계산서hp'], data['계산서tel'], 
                data['계산서fax'], data['계산서email'], data['계산서발행자'], data['의뢰인성명'], data['현장전화'], 
                data['시료채취자'], data['품질담당자'], data['현장담당'], data['시료명'], data['공수'], 
                Number(data['지급액합계'] || 0)
            ]);

            row.height = 24.75;

            // 숫자 형식 적용
            moneyCols.forEach(col => {
                const cell = row.getCell(col);
                cell.numFmt = '#,##0';
            });

            row.getCell('N').value = { formula: `L${currentRow}+M${currentRow}` };
            row.getCell('W').value = { formula: `L${currentRow}-(P${currentRow}-Q${currentRow}-R${currentRow}-S${currentRow}-T${currentRow}-U${currentRow}-V${currentRow})` };
            
            // 적용금액 빨간색 스타일 (오른쪽 정렬 유지 위해 font만 수정)
            row.getCell('W').font = { color: { argb: 'FFFF0000' }, bold: false, size: 10 };

            ['H', 'J'].forEach(colKey => {
                const cell = row.getCell(colKey);
                if (blueKeywords.some(k => String(cell.value || "").includes(k))) {
                    cell.font = { color: { argb: 'FF0D6EFD' }, bold: true, size: 10 };
                }
            });
            currentRow++;
        });

        const endRow = currentRow - 1;
        const totalRow = worksheet.addRow([]);
        totalRow.height = 24.75;

        for (let i = 1; i <= 42; i++) {
            const cell = totalRow.getCell(i);
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFE1E1' } };
            cell.font = { bold: true, size: 10 };
        }

        const totalTitleCell = totalRow.getCell('I');
        totalTitleCell.value = `${project} 합계`;
        totalTitleCell.font = { bold: true, size: 9 };
        totalTitleCell.alignment = { horizontal: 'left', vertical: 'middle', wrapText: true };

        // 합계 수식 및 숫자 형식
        ['L', 'M', 'N', 'W', 'X', 'Z', 'AP'].forEach(col => {
            const cell = totalRow.getCell(col);
            cell.value = { formula: `SUM(${col}${startRow}:${col}${endRow})` };
            cell.numFmt = '#,##0';
            cell.alignment = { horizontal: 'right', vertical: 'middle' }; // 합계 금액도 오른쪽 정렬
        });
        currentRow++;
    });

    const buffer = await workbook.xlsx.writeBuffer();
    saveAs(new Blob([buffer]), `정산보고서_${new Date().toISOString().slice(0,10)}.xlsx`);
}
</script>

{% endblock %}