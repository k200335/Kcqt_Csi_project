{% extends "base.html" %}
{% block content %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>    
</head>    
<div class="container-fluid py-3">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light py-3">
            <form id="searchForm" class="row g-2 align-items-center">
                <div class="col-auto">
                    <select class="form-select form-select-sm" id="dateType">
                        <option value="deposit">ì…ê¸ˆì¼ ê¸°ì¤€</option>
                        <option value="receipt">ì‹¤ì ‘ìˆ˜ì¼ ê¸°ì¤€</option>
                    </select>
                </div>
                
                <div class="col-auto d-flex align-items-center">
                    <input type="date" class="form-control form-select-sm" id="startDate">
                    <span class="mx-1">~</span>
                    <input type="date" class="form-control form-select-sm" id="endDate">
                </div>

                <div class="col-auto">
                    <select class="form-select form-select-sm" id="searchType">
                        <option value="sales_man">ì˜ì—…ë‹´ë‹¹</option>
                        <option value="qt_no">QTë²ˆí˜¸</option>
                        <option value="agency">ì˜ë¢°ê¸°ê´€ëª…</option>
                        <option value="project">ê³µì‚¬ëª…</option>
                        <option value="seal">ë´‰ì¸ëª…</option>
                    </select>
                </div>

                <div class="col-auto">
                    <input type="text" class="form-control form-select-sm" id="searchText" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" style="width: 200px;">
                </div>

                <div class="col-auto">
                    <button type="button" class="btn btn-primary btn-sm px-3" onclick="onSearch()">ì¡°íšŒ</button>
                </div>
                <input type="file" id="excelFileInput" style="display: none;" accept=".xlsx, .xls" onchange="processExcelFile(event)">
                <div class="col-auto ms-auto d-flex gap-2"> 
                    <button type="button" class="btn btn-warning btn-sm px-3" onclick="importAppliedAmounts()">
                        <i class="bi bi-download"></i> ì—‘ì…€ ê°€ì ¸ì˜¤ê¸°
                    </button>
                    <button type="button" class="btn btn-primary btn-sm px-3" onclick="onSaveToDB()">
                        <i class="bi bi-cloud-upload"></i> ë§ˆê°í•˜ê¸°
                    </button>
                    <button type="button" class="btn btn-success btn-sm px-3" onclick="onBtExport()">
                        <i class="bi bi-file-earmark-excel"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </form>
        </div>

        <div class="card-body p-0">
            <div id="myGrid" style="height: 600px; width: 100%;" class="ag-theme-alpine"></div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-3"><div class="card p-3 shadow-sm border-0 bg-primary text-white text-center"><h6>ì´ ê³µê¸‰ê°€ì•¡</h6><h4 id="stat-supply">0</h4></div></div>
        <div class="col-md-3"><div class="card p-3 shadow-sm border-0 bg-success text-white text-center"><h6>ì´ ì…ê¸ˆì•¡</h6><h4 id="stat-deposit">0</h4></div></div>
        <div class="col-md-3"><div class="card p-3 shadow-sm border-0 bg-danger text-white text-center"><h6>ì´ ë¯¸ìˆ˜ê¸ˆ</h6><h4 id="stat-unpaid">0</h4></div></div>
        <div class="col-md-3"><div class="card p-3 shadow-sm border-0 bg-info text-white text-center"><h6>ì¡°íšŒ ê±´ìˆ˜</h6><h4 id="stat-count">0ê±´</h4></div></div>
    </div>
</div>


<script>
    // 1. ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
    let gridApi;

    // 2. [ê¸°ì–µ ì‚¬í•­] ë°©ëŒ€í•œ ì»¬ëŸ¼ ì •ì˜ (ëˆ„ë½ ì—†ì´ ì „ì²´ ë³µêµ¬)
    const columnDefs = [
        { headerName: "ë‹´ë‹¹ì", field: "ë‹´ë‹¹ì", width: 100, pinned: 'left' },
        { 
            headerName: "ë¯¸ì¸ì •", 
            field: "ë¯¸ì¸ì •", 
            width: 80, pinned: 'left',
            // ë§Œì•½ ë°ì´í„°ê°€ 1ì´ë©´ 'ë¯¸ì¸ì •', 0ì´ë©´ 'ì¸ì •'ìœ¼ë¡œ í‘œì‹œí•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©
            valueFormatter: p => p.value == '1' ? 'ë¯¸ì¸ì •' : (p.value == '0' ? 'ì¸ì •' : p.value)
        },
        { headerName: "ì˜ë¢°ë²ˆí˜¸", field: "ì˜ë¢°ë²ˆí˜¸", width: 150, pinned: 'left' },
        { headerName: "ì§€ì›", field: "ì§€ì›", width: 80 }, 
        { headerName: "ì˜ì—…ë‹´ë‹¹", field: "ì˜ì—…ë‹´ë‹¹", width: 100 },
        { headerName: "QTë²ˆí˜¸", field: "QTë²ˆí˜¸", width: 140 },
        // { headerName: "ì‹¤ì ‘ìˆ˜ì¼", field: "ì‹¤ì ‘ìˆ˜ì¼", width: 140 },
        { headerName: "ì‹¤ì ‘ìˆ˜ì¼", field: "ì‹¤ì ‘ìˆ˜ì¼", width: 120,
            // ğŸŒŸ '2025-12-17T14:16:03.130' -> '2025-12-17'ë¡œ ë³€í™˜
            valueFormatter: p => {
                if (p.value && p.value.includes('T')) {
                    return p.value.split('T')[0];
                }
                return p.value || "";
            }
        },
        { headerName: "ì˜ë¢°ê¸°ê´€ëª…", field: "ì˜ë¢°ê¸°ê´€ëª…", width: 220 },
        { headerName: "ê³µì‚¬ëª…", field: "ì‚¬ì—…ëª…", width: 300 },
        { headerName: "ë´‰ì¸ëª…", field: "ë´‰ì¸ëª…", width: 220 },
        { headerName: "ì‹œë£ŒëŸ‰", field: "ì‹œë£ŒëŸ‰", width: 100 },
        
        // ê¸ˆì•¡ ê´€ë ¨ (ìˆ«ì í¬ë§·íŒ…: Math.floor + toLocaleString)
        { headerName: "ê³µê¸‰ê°€ì•¡", field: "ê³µê¸‰ê°€ì•¡", width: 120, type: 'numericColumn', valueFormatter: p => Math.floor(p.value || 0).toLocaleString() },
        { headerName: "ë¶€ê°€ì„¸", field: "ë¶€ê°€ì„¸", width: 110, type: 'numericColumn', valueFormatter: p => Math.floor(p.value || 0).toLocaleString() },
        { headerName: "í•©ê³„", valueGetter: p => (Number(p.data.ê³µê¸‰ê°€ì•¡ || 0) + Number(p.data.ë¶€ê°€ì„¸ || 0)), width: 120, type: 'numericColumn', valueFormatter: p => p.value.toLocaleString() },
        
        // ì¶”ê°€ ë¹„ìš© í•­ëª©ë“¤
        // { headerName: "ì¶œì¥ë¹„êµ¬ë¶„", field: "ì¶œì¥ë¹„êµ¬ë¶„", width: 120 },
        { headerName: "ì¶œì¥ë¹„êµ¬ë¶„", field: "ì¶œì¥ë¹„êµ¬ë¶„", width: 100,
        // ğŸŒŸ ì´ ë¶€ë¶„ì´ í•µì‹¬ì…ë‹ˆë‹¤! ğŸŒŸ
        valueFormatter: p => {
            if (p.value == '1') return "ë³¸ì›";
            if (p.value == '2') return "ì§€ì›";
            return p.value || ""; // 1, 2ê°€ ì•„ë‹ˆë©´ ì›ë˜ ê°’ ì¶œë ¥
            }
        },
        { headerName: "ì¶œì¥ë¹„", field: "ì¶œì¥ë¹„", width: 100, valueFormatter: p => (p.value || 0).toLocaleString() },        
        { headerName: "ê¸°ë³¸ë£Œ", field: "ê¸°ë³¸ë£Œ", width: 100, valueFormatter: p => (p.value || 0).toLocaleString() },
        { headerName: "ì •ë³´ì²˜ë¦¬ë¹„", field: "ì •ë³´ì²˜ë¦¬ë¹„", width: 110, valueFormatter: p => (p.value || 0).toLocaleString() },
        { headerName: "ì‹œí¸ì œì‘ë¹„", field: "ì‹œí¸ì œì‘ë¹„", width: 110, valueFormatter: p => (p.value || 0).toLocaleString() },
        { headerName: "ì§€ê²Œì°¨ìš´ì„", field: "ì§€ê²Œì°¨ìš´ì„", width: 110, valueFormatter: p => (p.value || 0).toLocaleString() },
        { headerName: "ì‹œë£Œìˆ˜ê±°ë¹„", field: "ì‹œë£Œìˆ˜ê±°ë¹„", width: 110 },
        { headerName: "ì²­êµ¬ìœ„íƒì‹œí—˜ë¹„", field: "ì²­êµ¬ìœ„íƒì‹œí—˜ë¹„", width: 130, valueFormatter: p => (p.value || 0).toLocaleString() },
        
        // ì •ì‚° ë° ì…ê¸ˆ ì •ë³´ (ì…ê¸ˆì•¡ ë°°ê²½ìƒ‰ ìœ ì§€)
        { headerName: "ì ìš©ê¸ˆì•¡", field: "ì ìš©ê¸ˆì•¡", width: 120 },
        {
            headerName: "ì¸ì„¼í‹°ë¸Œ",
            field: "ì¸ì„¼í‹°ë¸Œ",
            valueFormatter: params => {
                if (!params.value) return 0;
                // ì†Œìˆ˜ì  ë°˜ì˜¬ë¦¼ í›„ ì²œë‹¨ìœ„ ì½¤ë§ˆ í¬ë§·íŒ…
                return Math.round(params.value).toLocaleString();
            }
        },
        { headerName: "ì…ê¸ˆì¼", field: "ì…ê¸ˆì¼", width: 120 },
        { headerName: "ì…ê¸ˆì•¡", field: "ì…ê¸ˆì•¡", width: 120, cellStyle: {'background-color': '#e6fffa'}, valueFormatter: p => (p.value || 0).toLocaleString() },
        
        // ê³„ì‚°ì„œ ë° ì—°ë½ì²˜ ì •ë³´
        { headerName: "ê³„ì‚°ì„œë°œí–‰íšŒì‚¬ëª…", field: "ê³„ì‚°ì„œë°œí–‰íšŒì‚¬ëª…", width: 180 },
        { headerName: "ê³„ì‚°ì„œë°œí–‰ì¼", field: "ê³„ì‚°ì„œë°œí–‰ì¼", width: 120 },
        { headerName: "ê³„ì‚°ì„œë‹´ë‹¹ì", field: "ê³„ì‚°ì„œë‹´ë‹¹ì", width: 120 },
        { headerName: "ê³„ì‚°ì„œhp", field: "ê³„ì‚°ì„œhp", width: 130 },
        { headerName: "ê³„ì‚°ì„œtel", field: "ê³„ì‚°ì„œtel", width: 130 },
        { headerName: "ê³„ì‚°ì„œfax", field: "ê³„ì‚°ì„œfax", width: 130 },
        { headerName: "ê³„ì‚°ì„œemail", field: "ê³„ì‚°ì„œemail", width: 180 },
        { headerName: "ê³„ì‚°ì„œë°œí–‰ì", field: "ê³„ì‚°ì„œë°œí–‰ì", width: 120 },
        
        // ì˜ë¢°ì¸ ìƒì„¸
        { headerName: "ì˜ë¢°ì¸ì„±ëª…", field: "ì˜ë¢°ì¸ì„±ëª…", width: 120 },
        { headerName: "í˜„ì¥ì „í™”", field: "í˜„ì¥ì „í™”", width: 130 },
        { headerName: "ì‹œë£Œì±„ì·¨ì", field: "ì‹œë£Œì±„ì·¨ì", width: 120 },
        { headerName: "í’ˆì§ˆë‹´ë‹¹ì", field: "í’ˆì§ˆë‹´ë‹¹ì", width: 120 },
        { headerName: "í˜„ì¥ë‹´ë‹¹", field: "í˜„ì¥ë‹´ë‹¹", width: 100 },
        { headerName: "ì‹œë£Œëª…", field: "ì‹œë£Œëª…", width: 150 },
        { 
            headerName: "ê³µìˆ˜", 
            field: "ê³µìˆ˜", 
            width: 80, 
            type: 'numericColumn' 
        },
        { 
            headerName: "ì§€ê¸‰ì•¡í•©ê³„", 
            field: "ì§€ê¸‰ì•¡í•©ê³„", 
            width: 120, 
            type: 'numericColumn',
            valueFormatter: p => Math.floor(p.value || 0).toLocaleString() + "ì›"
        },
    ];

    // columnDefs ë°°ì—´ ë‚´ë¶€ì˜ ì¶œì¥ë¹„êµ¬ë¶„ ì»¬ëŸ¼ì„ ì°¾ì•„ì„œ ìˆ˜ì •í•˜ì„¸ìš”
    
    // 1. ê·¸ë¦¬ë“œ ì˜µì…˜ ì„¤ì • ë¶€ë¶„ ìˆ˜ì •
const gridOptions = {
    columnDefs: columnDefs,
    rowData: [], 
    // --- ë†’ì´ ì¡°ì ˆ ì†ì„± ì¶”ê°€ ---
    headerHeight: 30,      // í—¤ë” ë†’ì´ ì¤„ì„
    rowHeight: 33,         // í–‰ ë†’ì´ ì¤„ì„
    // -----------------------
    defaultColDef: {
        resizable: true,
        sortable: true,
        filter: true,
        flex: 0,
        minWidth: 100
    },
    pagination: false,
    overlayLoadingTemplate: '<span class="ag-overlay-loading-center">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</span>',
    onGridReady: (params) => {
        gridApi = params.api; // ê¸°ì¡´ gridApi ë³€ìˆ˜ í™œìš©
        window.finishedGridApi = params.api;
        console.log("ê·¸ë¦¬ë“œ API ì—°ê²° ì™„ë£Œ");
    },
};

// 2. í†µí•©ëœ window.onload ë¡œì§
window.onload = function() {
    // ë‚ ì§œ ìë™ ì„¤ì •
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 2).toISOString().split('T')[0].substring(0, 8) + '01';
    
    document.getElementById('startDate').value = firstDay;
    document.getElementById('endDate').value = today;

    // ê·¸ë¦¬ë“œ ìƒì„±
    const gridDiv = document.querySelector('#myGrid');
    if (gridDiv) {
        gridApi = agGrid.createGrid(gridDiv, gridOptions);
        
        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        const rawData = `{{ final_results|safe }}` || '[]';
        try {
            const initialData = JSON.parse(rawData);
            if (initialData.length > 0) {
                gridApi.setGridOption('rowData', initialData);
                updateSummaryCards(initialData);
            }
        } catch (e) {
            console.warn("ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜");
        }
    }
};

    // 5. ì¡°íšŒ í•¨ìˆ˜ (Ajax)
    function onSearch() {
        if (!gridApi) {
            alert("ê·¸ë¦¬ë“œê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }

        const params = new URLSearchParams({
            date_type: document.getElementById('dateType').value,
            start_date: document.getElementById('startDate').value,
            end_date: document.getElementById('endDate').value,
            search_type: document.getElementById('searchType').value,
            search_text: document.getElementById('searchText').value
        });

        gridApi.setGridOption('loading', true);

        fetch(`/receipt_settle_admin/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                gridApi.setGridOption('rowData', data);
                updateSummaryCards(data);
                gridApi.setGridOption('loading', false);
            })
            .catch(error => {
                console.error('Error:', error);
                gridApi.setGridOption('loading', false);
                alert("ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }

    // 6. í•˜ë‹¨ ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸ (ì •ì‚° ìˆ˜ì‹ í¬í•¨)
    function updateSummaryCards(data) {
        let totalSupply = 0;
        let totalDeposit = 0;

        data.forEach(row => {
            totalSupply += (Number(row.ê³µê¸‰ê°€ì•¡) || 0);
            totalDeposit += (Number(row.ì…ê¸ˆì•¡) || 0);
        });

        // ë¯¸ìˆ˜ê¸ˆ: (ê³µê¸‰ê°€ì•¡ * 1.1) - ì…ê¸ˆì•¡
        let totalUnpaid = (totalSupply * 1.1) - totalDeposit;

        document.getElementById('stat-supply').innerText = totalSupply.toLocaleString() + 'ì›';
        document.getElementById('stat-deposit').innerText = totalDeposit.toLocaleString() + 'ì›';
        document.getElementById('stat-unpaid').innerText = Math.floor(totalUnpaid).toLocaleString() + 'ì›';
        document.getElementById('stat-count').innerText = data.length.toLocaleString() + 'ê±´';
    }


async function onBtExport() {
    if (!gridApi) return;

    const templatePath = '/static/excel_templates/my_template.xlsx';

    try {
        const response = await fetch(templatePath);
        if (!response.ok) throw new Error("ì—‘ì…€ ì–‘ì‹ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        const arrayBuffer = await response.arrayBuffer();
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(arrayBuffer);
        const worksheet = workbook.getWorksheet(1);

        let rowData = [];
        gridApi.forEachNodeAfterFilterAndSort((node) => {
            if (node.data) rowData.push({ ...node.data });
        });

        rowData.sort((a, b) => (a.ì‚¬ì—…ëª… || "").localeCompare(b.ì‚¬ì—…ëª… || ""));

        let currentProject = "";
        let currentRowIndex = 2; 
        let groupStartRow = 2;   
        
        // ğŸŒŸ [ìˆ˜ì •] 1. subtotal ë³€ìˆ˜ ì´ˆê¸°í™” (ì´ ë¶€ë¶„ì´ ëˆ„ë½ë˜ì–´ ì—ëŸ¬ ë°œìƒ)
        let subtotal = { supply: 0, vat: 0, deposit: 0, payment: 0, applied_amount: 0, incentive: 0 };

        rowData.forEach((data, index) => {
            if (currentProject !== "" && currentProject !== data.ì‚¬ì—…ëª…) {
                // ì†Œê³„ ì‚½ì…
                insertSubtotalRow(worksheet, currentProject, groupStartRow, currentRowIndex - 1, currentRowIndex);
                currentRowIndex++;
                groupStartRow = currentRowIndex;
                
                // ğŸŒŸ [ìˆ˜ì •] 2. ë‹¤ìŒ ê·¸ë£¹ì„ ìœ„í•´ subtotal ì´ˆê¸°í™”
                subtotal = { supply: 0, vat: 0, deposit: 0, payment: 0, applied_amount: 0, incentive: 0 };
            }

            const supply = Number(data.ê³µê¸‰ê°€ì•¡ || 0);
            const vat = Number(data.ë¶€ê°€ì„¸ || 0);
            const deposit = Number(data.ì…ê¸ˆì•¡ || 0);
            const payment = Number(data.ì§€ê¸‰ì•¡í•©ê³„ || 0);
            const appliedPrice = Number(data.ì ìš©ê¸ˆì•¡ || 0);
            const incentive = Math.round(Number(data.ì¸ì„¼í‹°ë¸Œ || 0)); // ğŸŒŸ ì¸ì„¼í‹°ë¸Œ ì†Œìˆ˜ì  ì œê±°
            const row = worksheet.getRow(currentRowIndex);

            // ì‹¤ì ‘ìˆ˜ì¼ ë° ì¶œì¥ë¹„êµ¬ë¶„ í¬ë§·íŒ…
            const formattedDate = (data.ì‹¤ì ‘ìˆ˜ì¼ && String(data.ì‹¤ì ‘ìˆ˜ì¼).includes('T'))
                ? data.ì‹¤ì ‘ìˆ˜ì¼.split('T')[0]
                : (data.ì‹¤ì ‘ìˆ˜ì¼ || "");

            const formattedTripType = data.ì¶œì¥ë¹„êµ¬ë¶„ == '1' ? "ë³¸ì›" : (data.ì¶œì¥ë¹„êµ¬ë¶„ == '2' ? "ì§€ì›" : (data.ì¶œì¥ë¹„êµ¬ë¶„ || ""));

            row.values = [
                data.ë‹´ë‹¹ì,
                data.ë¯¸ì¸ì • == '1' ? 'ë¯¸ì¸ì •' : (data.ë¯¸ì¸ì • == '0' ? 'ì¸ì •' : data.ë¯¸ì¸ì •),
                data.ì˜ë¢°ë²ˆí˜¸, data.ì§€ì›, data.ì˜ì—…ë‹´ë‹¹, data.QTë²ˆí˜¸,
                formattedDate, data.ì˜ë¢°ê¸°ê´€ëª…, data.ì‚¬ì—…ëª…, data.ë´‰ì¸ëª…, data.ì‹œë£ŒëŸ‰,
                supply, vat, supply + vat,
                formattedTripType,
                Number(data.ì¶œì¥ë¹„ || 0), Number(data.ê¸°ë³¸ë£Œ || 0), Number(data.ì •ë³´ì²˜ë¦¬ë¹„ || 0),
                Number(data.ì‹œí¸ì œì‘ë¹„ || 0), Number(data.ì§€ê²Œì°¨ìš´ì„ || 0), data.ì‹œë£Œìˆ˜ê±°ë¹„,
                Number(data.ì²­êµ¬ìœ„íƒì‹œí—˜ë¹„ || 0), Number(appliedPrice || 0), // 23ë²ˆì§¸: ì ìš©ê¸ˆì•¡
                Number(data.ì¸ì„¼í‹°ë¸Œ || 0), data.ì…ê¸ˆì¼, deposit,
                data.ê³„ì‚°ì„œë°œí–‰íšŒì‚¬ëª…, data.ê³„ì‚°ì„œë°œí–‰ì¼, data.ê³„ì‚°ì„œë‹´ë‹¹ì, data.ê³„ì‚°ì„œhp,
                data.ê³„ì‚°ì„œtel, data.ê³„ì‚°ì„œfax, data.ê³„ì‚°ì„œemail, data.ê³„ì‚°ì„œë°œí–‰ì,
                data.ì˜ë¢°ì¸ì„±ëª…, data.í˜„ì¥ì „í™”, data.ì‹œë£Œì±„ì·¨ì, data.í’ˆì§ˆë‹´ë‹¹ì,
                data.í˜„ì¥ë‹´ë‹¹, data.ì‹œë£Œëª…, data.ê³µìˆ˜, Number(payment || 0)
            ];

            // ê¸ˆì•¡ ì»¬ëŸ¼ í¬ë§·íŒ…
            [12, 13, 14, 16, 17, 18, 19, 20, 22, 23, 24, 26, 42].forEach(col => {
                row.getCell(col).numFmt = '#,##0';
            });

            currentRowIndex++;
            currentProject = data.ì‚¬ì—…ëª…;
            
            // ë°ì´í„° ëˆ„ì 
            subtotal.supply += supply;
            subtotal.vat += vat;
            subtotal.deposit += deposit;
            subtotal.payment += payment;
            subtotal.applied_amount += appliedPrice;
            subtotal.incentive += incentive; // ğŸŒŸ ì¸ì„¼í‹°ë¸Œ í•©ê³„ ëˆ„ì 

            if (index === rowData.length - 1) {
                insertSubtotalRow(worksheet, currentProject, groupStartRow, currentRowIndex - 1, currentRowIndex);
                currentRowIndex++;
            }
        });

        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), `ì˜ì—…ì •ì‚°í˜„í™©_${new Date().toISOString().slice(0, 10)}.xlsx`);

    } catch (error) {
        console.error(error); // ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ë” ìì„¸í•œ ì—ëŸ¬ í™•ì¸ ê°€ëŠ¥
        alert("ì—ëŸ¬: " + error.message);
    }
}

function insertSubtotalRow(ws, projectName, startLine, endLine, targetRow) {
    const row = ws.getRow(targetRow);
    row.getCell(9).value = `[${projectName}] ì†Œê³„`;

    // L(12), M(13), N(14), W(23), Z(26), AP(42)
    const sumCols = [
        { idx: 12, col: 'L' }, { idx: 13, col: 'M' }, { idx: 14, col: 'N' },
        { idx: 23, col: 'W' }, { idx: 24, col: 'X' }, { idx: 26, col: 'Z' }, 
        { idx: 42, col: 'AP' }
    ];

    sumCols.forEach(item => {
        row.getCell(item.idx).value = {
            formula: `SUM(${item.col}${startLine}:${item.col}${endLine})`
        };
        row.getCell(item.idx).numFmt = '#,##0';
    });

    // ìŠ¤íƒ€ì¼ ì ìš© (ìƒëµ...)
    for (let i = 1; i <= 42; i++) {
        const cell = row.getCell(i);
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFD1DC' } };
        cell.font = { bold: true };
    }
}






// ê·¸ë¦¬ë“œì— ì ìš©ê¸ˆì•¡ ë„£ê¸°

/**
 * [ì ìš©ê¸ˆì•¡ ê°€ì ¸ì˜¤ê¸°] ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
 */
window.importAppliedAmounts = function() {
    // íŒŒì¼ ì„ íƒì°½ ê°•ì œ í´ë¦­
    const fileInput = document.getElementById('excelFileInput');
    if (fileInput) {
        fileInput.click();
    } else {
        alert("íŒŒì¼ ì„ íƒ input(id='excelFileInput')ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
};

/**
 * íŒŒì¼ì´ ì„ íƒë˜ì—ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì‹¤ì œ ë¡œì§
 */
window.processExcelFile = function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const excelRows = XLSX.utils.sheet_to_json(sheet);
            
            updateGridWithExcelData(excelRows);
        } catch (err) {
            console.error("Excel Parsing Error:", err);
            alert("ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            event.target.value = ''; // ê°™ì€ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥í•˜ê²Œ ì´ˆê¸°í™”
        }
    };
    reader.readAsArrayBuffer(file);
};

/**
 * ê·¸ë¦¬ë“œ ë°ì´í„° ë§¤ì¹­ ë° ì—…ë°ì´íŠ¸
 */
function updateGridWithExcelData(excelRows) {
    const gridApi = window.finishedGridApi; // ìœ ì €ë‹˜ì˜ ê·¸ë¦¬ë“œ API ë³€ìˆ˜ëª… í™•ì¸ í•„ìš”
    if (!gridApi) {
        alert("ê·¸ë¦¬ë“œ APIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    let updateCount = 0;
    const itemsToUpdate = [];

    gridApi.forEachNode((node) => {
        // ì—‘ì…€ì˜ í—¤ë”ëª…ì´ 'QTë²ˆí˜¸', 'ì ìš©ê¸ˆì•¡'ì´ë¼ê³  ê°€ì •
        // ìœ ì €ë‹˜ì˜ ê·¸ë¦¬ë“œ ë°ì´í„° í‚¤ê°’ì´ 'QTë²ˆí˜¸'ë¼ê³  ê°€ì •
        const gridQtNo = String(node.data['QTë²ˆí˜¸'] || '').trim();
        
        const matchedRow = excelRows.find(exRow => 
            String(exRow['QTë²ˆí˜¸'] || '').trim() === gridQtNo
        );

        if (matchedRow) {
            // 'ì ìš©ê¸ˆì•¡' ì»¬ëŸ¼ì˜ ê°’ì„ 'ê³µê¸‰ê°€ì•¡' í•„ë“œì— ë°˜ì˜
            node.setDataValue('ì¸ì„¼í‹°ë¸Œ', matchedRow['ì¸ì„¼í‹°ë¸Œ'] || 0);
            updateCount++;
        }
    });

    if (updateCount > 0) {
        alert(`ì´ ${updateCount}ê±´ì˜ ì¸ì„¼í‹°ë¸Œê°€ ê·¸ë¦¬ë“œì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        // í†µê³„ ìˆ˜ì¹˜ ì¬ê³„ì‚° í•¨ìˆ˜ê°€ ìˆë‹¤ë©´ ì—¬ê¸°ì„œ í˜¸ì¶œ (ì˜ˆ: calculateStats())
    } else {
        alert("ë§¤ì¹­ë˜ëŠ” QTë²ˆí˜¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì—‘ì…€ì˜ 'QTë²ˆí˜¸' ì»¬ëŸ¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
}

// -------------------ì—¬ê¸°ì„œë¶€í„° dbì—°ê²°í›„ ì¸ì„¼ë„£ê¸° ì½”ë“œ ì‹œì‘ì…ë‹ˆë‹¤.-------------------

/**
 * DBì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ê·¸ë¦¬ë“œì— ë°˜ì˜ (ë§ˆê°í•˜ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ)
 */
async function onSaveToDB() {
    const gridApi = window.finishedGridApi; 
    if (!gridApi) {
        alert("ê·¸ë¦¬ë“œ APIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    try {
        // 1. ì„œë²„ DBë¡œë¶€í„° ë°ì´í„° ì¡°íšŒ (API í˜¸ì¶œ)
        // ì‹¤ì œ ìš´ì˜í•˜ì‹œëŠ” ì„œë²„ í™˜ê²½ì˜ URLë¡œ ë³€ê²½í•˜ì„¸ìš”.
        const response = await fetch("{% url 'get_qt_incentives' %}"); 
        if (!response.ok) throw new Error("DB ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        
        const dbData = await response.json(); // [{ "QTë²ˆí˜¸": "...", "ê¸ˆì•¡": 1000 }, ...] í˜•ì‹ ì˜ˆìƒ

        let updateCount = 0;

        // 2. ê·¸ë¦¬ë“œ ì „ì²´ ë…¸ë“œë¥¼ ìˆœíšŒí•˜ë©° ë§¤ì¹­
        gridApi.forEachNode((node) => {
            const gridQtNo = String(node.data['QTë²ˆí˜¸'] || '').trim();
            
            // DB ë°ì´í„°ì—ì„œ í•´ë‹¹ QTë²ˆí˜¸ ì°¾ê¸°
            const matchedRow = dbData.find(dbRow => 
                String(dbRow['QTë²ˆí˜¸'] || '').trim() === gridQtNo
            );

            if (matchedRow) {
                // 'ê¸ˆì•¡' ì»¬ëŸ¼ì˜ ê°’ì„ 'ì¸ì„¼í‹°ë¸Œ' í•„ë“œì— ë°˜ì˜
                node.setDataValue('ì¸ì„¼í‹°ë¸Œ', matchedRow['ê¸ˆì•¡'] || 0);
                updateCount++;
            }
        });

        if (updateCount > 0) {
            alert(`DB ì¡°íšŒë¥¼ í†µí•´ ì´ ${updateCount}ê±´ì˜ ì¸ì„¼í‹°ë¸Œê°€ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            // í•„ìš” ì‹œ í†µê³„ ì¬ê³„ì‚° í•¨ìˆ˜ í˜¸ì¶œ
            // if (typeof calculateStats === 'function') calculateStats();
        } else {
            alert("ê·¸ë¦¬ë“œì˜ QTë²ˆí˜¸ì™€ ì¼ì¹˜í•˜ëŠ” DB ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }

    } catch (err) {
        console.error("DB Update Error:", err);
        alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
    }
}

// -------------------ì—¬ê¸°ê¹Œì§€ dbì—°ê²°í›„ ì¸ì„¼ë„£ê¸° ì½”ë“œ ëì…ë‹ˆë‹¤.-------------------


</script>
</html>
{% endblock %}