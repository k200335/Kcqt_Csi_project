{% extends "base.html" %}
{% block content %}
<!DOCTYPE html>
<html lang="ko">
<head>
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<style>
    /* 4ë“±ë¶„ ê³ ì • ë ˆì´ì•„ì›ƒ */
    .split-wrapper {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        height: calc(100vh - 70px);
        width: 100%;
        gap: 0;
    }

    .panel { 
        overflow: auto; 
        padding: 15px; 
        background: white; 
        border: 1px solid #dee2e6; 
    }
    .panel-bg { background-color: #f8f9fa; }
    .table-custom { font-size: 0.82rem; width: 100%; }
    .sticky-top { position: sticky; top: 0; background: white; z-index: 10; }
</style>

<div class="split-wrapper">
    <div class="panel" id="panel-1">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold text-primary mb-0">1. CSI ì„±ì ì„œ ë°œê¸‰ ì •ë³´ ë§¤ì¹­</h5>
            <div class="d-flex gap-2 align-items-center">
                <input type="date" id="start_date" class="form-control form-control-sm" style="width:130px;" value="{{ default_date }}">
                <span class="fw-bold">~</span>
                <input type="date" id="end_date" class="form-control form-control-sm" style="width:130px;" value="{{ default_date }}">
                <button id="btn-fetch" class="btn btn-sm btn-dark" onclick="fetchCsiIssueList(event)" disabled>ì¡°íšŒ</button>
                <button id="btn-save" class="btn btn-sm btn-success" onclick="saveMatchingData()" disabled>DB ì €ì¥</button>
                <button id="btn-excel" class="btn btn-sm btn-outline-success" onclick="downloadExcel()" disabled>
                    <i class="bi bi-file-earmark-excel"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                </button>
            </div>
        </div>
        
        <table class="table table-sm table-bordered table-custom">
            <thead class="table-light sticky-top text-center">
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="check-all"></th>
                    <th>ì˜ë¢°ë²ˆí˜¸</th> <th>ì„±ì ì„œë²ˆí˜¸</th> <th>ë´‰ì¸ëª…</th> <th>ê³µì‚¬ëª…</th>
                    <th>ì˜ë¢°ê¸°ê´€</th> <th>ì˜ë¢°ì¼ì</th> <th>ì ‘ìˆ˜ì¼ì</th> <th>ëŒ€ê¸°ì¼ì</th> <th>ë°œê¸‰ì¼ì</th>
                </tr>
            </thead>
            <tbody id="csi-matching-body">
                <tr><td colspan="10" class="text-center text-muted">ë°œê¸‰ì¼ìë¥¼ ì„ íƒí•˜ê³  ì¡°íšŒë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>
            </tbody>
        </table>
    </div>

    <div class="panel" id="panel-2">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold text-info mb-0">2. CSI ì„±ì ì„œ ë°œê¸‰ëŒ€ê¸° ì •ë³´ ì¡°íšŒ</h5>
            <div class="d-flex gap-2 align-items-center">
                <button id="btn-fetch-2" class="btn btn-sm btn-dark" onclick="fetchQtData(event)" disabled>ì¡°íšŒ</button>
                
                <button id="btn-save-2" class="btn btn-sm btn-info text-white" onclick="saveQtData()" disabled>DB ì €ì¥</button>
                
                <button id="btn-excel-download-2" class="btn btn-sm btn-success" onclick="downloadExcel2()" disabled>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                
                <button id="btn-excel-upload-2" class="btn btn-sm btn-warning text-white" onclick="triggerExcelUpload2()" disabled>ì—‘ì…€ ê°€ì ¸ì˜¤ê¸°</button>
                
                <input type="file" id="excel_file_2" style="display:none;" onchange="uploadExcel2(event)" accept=".xlsx, .xls">
            </div>
        </div>
        <table class="table table-sm table-bordered table-custom">
            <thead class="table-light sticky-top text-center">
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="check-all-2"></th>
                    <th>ì˜ë¢°ë²ˆí˜¸</th> <th>ë°œê¸‰ëŒ€ê¸°ì¼ì</th> <th>ì ‘ìˆ˜ë²ˆí˜¸</th>
                    <th>ë´‰ì¸ëª…</th> <th>ì‹œí—˜Â·ê²€ì‚¬ ì¢…ëª©</th> <th>ê³µì‚¬ëª…</th>
                    <th>ì ‘ìˆ˜ì¼ì</th> <th>ì‹œí—˜Â·ê²€ì‚¬ì§„í–‰ í™•ì •ì¼ì</th> <th>ì§„í–‰ìƒíƒœ</th>
                </tr>
            </thead>
            <tbody id="qt-matching-body">
                <tr><td colspan="10" class="text-center text-muted">ë°ì´í„°ë¥¼ ì¡°íšŒí•´ ì£¼ì„¸ìš”.</td></tr>
            </tbody>
        </table>
    </div>

    <div class="panel" id="panel-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold text-success mb-0">3. ì˜ë¢°ì •ë³´(Q,E,Tê±´ ì…ë ¥)</h5>
            
            <div class="d-flex gap-2 align-items-center">
                <div class="me-2 fw-bold">ì´ <span id="total-count-3" class="text-primary">0</span>ê±´</div>
                
                <select id="search_type_3" class="form-select form-select-sm" style="width:120px;">
                    <option value="request_code">ì˜ë¢°ë²ˆí˜¸</option>
                    <option value="agency">ì˜ë¢°ê¸°ê´€ëª…</option>
                    <option value="project">ì‚¬ì—…ëª…</option>
                </select>
                
                <input type="text" id="search_text_3" class="form-control form-control-sm" style="width:150px;" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
                
                <button id="btn-fetch-3" class="btn btn-sm btn-dark" onclick="fetchPanel3Data()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button id="btn-save-3" class="btn btn-sm btn-primary" onclick="savePanel3Data()">DB ì €ì¥</button>
            </div>
        </div>
        
        <div id="grid-panel-3" class="ag-theme-alpine" style="height: 600px; width: 100%;"></div>
    </div>
    <div class="panel" id="panel-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold text-warning mb-0">4. ì •ì‚°ì •ë³´ê´€ë¦¬</h5>
            <div class="d-flex gap-2 align-items-center">
                <div class="me-2 fw-bold">ì´ <span id="total-count-4" class="text-primary">0</span>ê±´</div>
                <button class="btn btn-sm btn-success" onclick="triggerExcelUpload4()">ì—‘ì…€ ê°€ì ¸ì˜¤ê¸°</button>
                <input type="file" id="excel_file_4" style="display:none;" onchange="uploadExcel4(event)" accept=".xlsx, .xls">
                <div class="input-group input-group-sm" style="width: 200px;">
                    <span class="input-group-text bg-light">QTë²ˆí˜¸</span>
                    <input type="text" id="search_qt_no" class="form-control" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
                </div>
                <button class="btn btn-sm btn-dark" onclick="fetchPanel4Data()">DB ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button id="btn-save-4" class="btn btn-sm btn-primary" onclick="savePanel4Data()">DB ì €ì¥</button>
            </div>
        </div>

        <div class="table-responsive" style="height: 600px; overflow-y: auto; border: 1px solid #dee2e6;">
            <table class="table table-sm table-bordered table-hover text-center mb-0">
                <thead class="table-light sticky-top">
                    <tr>
                        <th><input type="checkbox" id="check-all-4"></th> <th>ID</th>
                        <th>QTë²ˆí˜¸</th>
                        <th style="width: 200px;">ê¸ˆì•¡</th>
                        <th>ë¹„ê³ </th> </tr>
                    </tr>
                </thead>
                <tbody id="panel-4-body">
                    <tr><td colspan="4" class="text-muted">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ ì£¼ì„¸ìš”.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    /* ì²´í¬ë°•ìŠ¤ ë¡œì§ */
    document.addEventListener('change', function(e) {
        if (e.target.id === 'check-all') {
            document.querySelectorAll('#csi-matching-body .row-check').forEach(cb => cb.checked = e.target.checked);
        }
        if (e.target.id === 'check-all-2') {
            document.querySelectorAll('#qt-matching-body .row-check-2').forEach(cb => cb.checked = e.target.checked);
        }
        // âœ¨ ë„¤ ë²ˆì§¸ í™”ë©´(í˜„ì¬ ì‘ì—… ì¤‘ì¸ í™”ë©´) ì „ì²´ ì„ íƒ ì¶”ê°€
        if (e.target.id === 'check-all-4') {
            document.querySelectorAll('#panel-4-body .row-checkbox-4').forEach(cb => cb.checked = e.target.checked);
        }
    });

    /* 1ë²ˆ ì˜ì—­ ë°ì´í„° ì¡°íšŒ */
    async function fetchCsiIssueList(event) {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const tbody = document.getElementById('csi-matching-body');
        const btn = event.target;

        tbody.innerHTML = `<tr><td colspan="10" class="text-center">ì¡°íšŒ ì¤‘...</td></tr>`;
        btn.disabled = true;

        try {
            const response = await fetch("{% url 'fetch_csi_issue_data' %}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                body: JSON.stringify({ start_date: startDate, end_date: endDate })
            });
            const data = await response.json();
            if (data.status === 'success') {
                tbody.innerHTML = '';
                data.results.forEach(item => {
                    tbody.insertAdjacentHTML('beforeend', `<tr>
                        <td class="text-center"><input type="checkbox" class="row-check"></td>
                        <td><strong>${item.u_id}</strong></td>
                        <td>${item.cert_no}</td><td>${item.seal_name}</td><td>${item.project_name}</td>
                        <td>${item.agency}</td><td>${item.req_date}</td><td>${item.recv_date}</td>
                        <td>${item.wait_date}</td><td>${item.issue_date}</td>
                    </tr>`);
                });
            }
        } catch (e) { alert("ì—ëŸ¬ ë°œìƒ"); } finally { btn.disabled = false; }
    }

    /* 1ë²ˆ ì˜ì—­ ì €ì¥ */
    /** 3. ë°ì´í„° ì €ì¥ ë° ì—…ë°ì´íŠ¸ (UPSERT) í•¨ìˆ˜ **/
async function saveMatchingData() {
    const selectedRows = document.querySelectorAll('.row-check:checked');
    
    if (selectedRows.length === 0) {
        return alert("ì €ì¥(ì—…ë°ì´íŠ¸)í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    }

    // ì‚¬ì§„ì˜ DB êµ¬ì¡°(ì˜ë¢°ë²ˆí˜¸, ì„±ì ì„œë²ˆí˜¸, ë°œê¸‰ì¼ì)ì— ë§ì¶° ë°ì´í„° ì¶”ì¶œ
    const itemsToSave = Array.from(selectedRows).map(checkbox => {
        const row = checkbox.closest('tr');
        return {
            u_id: row.cells[1].innerText.trim(),       // ì˜ë¢°ë²ˆí˜¸
            cert_no: row.cells[2].innerText.trim(),    // ì„±ì ì„œë²ˆí˜¸
            issue_date: row.cells[9].innerText.trim()  // ë°œê¸‰ì¼ì
        };
    });

    if (!confirm(`${itemsToSave.length}ê±´ì˜ ë°ì´í„°ë¥¼ DBì— ë°˜ì˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    try {
        const response = await fetch("{% url 'save_csi_matching_data' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ items: itemsToSave })
        });

        const result = await response.json();
        if (result.status === 'success') {
            alert(result.message);
            document.getElementById('check-all').checked = false;
            selectedRows.forEach(cb => cb.checked = false);
        } else {
            alert("ì €ì¥ ì‹¤íŒ¨: " + result.message);
        }
    } catch (e) {
        alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
}

function downloadExcel() {
    // 1. í…Œì´ë¸” ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    // í…Œì´ë¸” ì „ì²´ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ ìƒìœ„ table íƒœê·¸ë¥¼ ì„ íƒí•˜ê±°ë‚˜ idë¥¼ ì§€ì •í•˜ì„¸ìš”.
    // ì—¬ê¸°ì„œëŠ” table-custom í´ë˜ìŠ¤ë¥¼ ê°€ì§„ í…Œì´ë¸”ì„ ëŒ€ìƒìœ¼ë¡œ í•©ë‹ˆë‹¤.
    const table = document.querySelector('.table-custom');
    
    // 2. ì›Œí¬ë¶ ìƒì„±
    const wb = XLSX.utils.book_new();
    
    // 3. í…Œì´ë¸” ë°ì´í„°ë¥¼ ì‹œíŠ¸ë¡œ ë³€í™˜ 
    // display: noneì¸ ìš”ì†Œë‚˜ ì²´í¬ë°•ìŠ¤ ì—´ì„ ì œì™¸í•˜ê³  ì‹¶ì„ ë•Œ ì„¤ì •ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    const ws = XLSX.utils.table_to_sheet(table);

    // 4. íŒŒì¼ëª… ì„¤ì • (ì˜¤ëŠ˜ ë‚ ì§œ í¬í•¨)
    const today = new Date().toISOString().slice(0, 10);
    const filename = `CSI_ì„±ì ì„œ_ë§¤ì¹­ë¦¬ìŠ¤íŠ¸_${today}.xlsx`;

    // 5. ì—‘ì…€ íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, filename);
}

// ---------------------------------ì—¬ê¸°ê¹Œì§€ 1ë²ˆ ë--------------------------------------

    /* 2ë²ˆ ì˜ì—­ ì¡°íšŒ (ì¤€ë¹„ì¤‘) */
    /** 2ë²ˆ ì˜ì—­: CSI ë°œê¸‰ëŒ€ê¸° ì •ë³´ ìˆ˜ì§‘ (ì˜ë¢°ë²ˆí˜¸, ëŒ€ê¸°ì¼ì, ì ‘ìˆ˜ë²ˆí˜¸ ìˆœì„œ) **/
async function fetchQtData(event) {
    console.log("2ë²ˆ ì¡°íšŒ ë²„íŠ¼ í´ë¦­ë¨"); // ì‘ë™ í™•ì¸ìš© ë¡œê·¸
    const tbody = document.getElementById('qt-matching-body');
    const btn = event.target;

    // 1. ë¡œë”© í‘œì‹œ ë° ë²„íŠ¼ ë¹„í™œì„±í™”
    tbody.innerHTML = `<tr><td colspan="10" class="text-center py-4">ìƒì„¸í˜ì´ì§€ì—ì„œ ì˜ë¢°ë²ˆí˜¸ ë° ì ‘ìˆ˜ë²ˆí˜¸ë¥¼ ì‹¤ì‹œê°„ ìˆ˜ì§‘ ì¤‘ì…ë‹ˆë‹¤...</td></tr>`;
    btn.disabled = true;

    try {
        // 2. ì„œë²„ë¡œ ìš”ì²­ (bodyì— ë‚ ì§œ ë°ì´í„°ë¥¼ ë‹´ì§€ ì•ŠìŒ)
        const response = await fetch("{% url 'fetch_csi_wait_data' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({}) // ë¹ˆ ê°ì²´ ì „ì†¡
        });

        const data = await response.json();

        if (data.status === 'success') {
            tbody.innerHTML = ''; 
            
            if (!data.results || data.results.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center">ìˆ˜ì§‘ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }

            // 3. ë°ì´í„° ë Œë”ë§ (ì˜ë¢°ë²ˆí˜¸ | ë°œê¸‰ëŒ€ê¸°ì¼ì | ì ‘ìˆ˜ë²ˆí˜¸ ìˆœì„œ) <td>${item.cert_no}</td>
            data.results.forEach(item => {
                tbody.insertAdjacentHTML('beforeend', `
                    <tr>
                        <td class="text-center"><input type="checkbox" class="row-check-2"></td>
                        <td class="text-center"><strong class="text-info">${item.u_id}</strong></td> 
                        <td class="text-center text-danger fw-bold">${item.wait_date}</td>      
                        <td class="text-center">${item.receipt_no}</td>                        
                        <td>${item.seal_name}</td>
                        <td>${item.project_name}</td>
                        <td>${item.agency}</td>
                        <td class="text-center">${item.req_date}</td>
                        <td class="text-center">${item.recv_date}</td>
                    </tr>
                `);
            });
        } else {
            alert("ì—ëŸ¬ ë°œìƒ: " + data.message);
            tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>`;
        }
    } catch (e) {
        console.error(e);
        alert("í†µì‹  ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
        // 4. ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
        btn.disabled = false;
    }
}

    /* 5. 2ë²ˆ ì˜ì—­: DB ì €ì¥ (ì¶”ê°€ëœ ê¸°ëŠ¥) */
    async function saveQtData() {
    // 1. 2ë²ˆ ì˜ì—­ ì „ìš© ì²´í¬ë°•ìŠ¤ í´ë˜ìŠ¤(.row-check-2)ë¡œ ì„ íƒëœ í–‰ ê°€ì ¸ì˜¤ê¸°
    const selectedRows = document.querySelectorAll('.row-check-2:checked');
    
    if (selectedRows.length === 0) {
        return alert("ì €ì¥(ì—…ë°ì´íŠ¸)í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    }

    // 2. 2ë²ˆ í…Œì´ë¸” ìˆœì„œì— ë§ì¶° ë°ì´í„° ì¶”ì¶œ
    // ìˆœì„œ: ì²´í¬ë°•ìŠ¤(0) | ì˜ë¢°ë²ˆí˜¸(1) | ë°œê¸‰ëŒ€ê¸°ì¼ì(2) | ì ‘ìˆ˜ë²ˆí˜¸(3) ...
    const itemsToSave = Array.from(selectedRows).map(checkbox => {
        const row = checkbox.closest('tr');
        return {
            u_id: row.cells[1].innerText.trim(),       // ì˜ë¢°ë²ˆí˜¸
            wait_date: row.cells[2].innerText.trim(),  // ë°œê¸‰ëŒ€ê¸°ì¼ì -> íŒŒì´ì¬ì˜ 'ë°œê¸‰ì¼ì' ì»¬ëŸ¼ìœ¼ë¡œ ê°
            // receipt_no: row.cells[3].innerText.trim()  // ì ‘ìˆ˜ë²ˆí˜¸ (í•„ìš”ì‹œ DB í™•ì¥ ëŒ€ë¹„)
        };
    });

    if (!confirm(`${itemsToSave.length}ê±´ì˜ ë°ì´í„°ë¥¼ DBì— ë°˜ì˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì„±ì ì„œë²ˆí˜¸ëŠ” 'ìŠ¹ì¸ì „'ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.)`)) return;

    try {
        // 3. 2ë²ˆ ì „ìš© ì €ì¥ URL í˜¸ì¶œ
        const response = await fetch("{% url 'save_csi_wait_data' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ items: itemsToSave })
        });

        const result = await response.json();
        if (result.status === 'success') {
            alert(result.message);
            // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ í•´ì œ (2ë²ˆ ì˜ì—­ìš© IDê°€ ìˆë‹¤ë©´ ê·¸ê²ƒìœ¼ë¡œ ë³€ê²½)
            const checkAll2 = document.getElementById('check-all-2');
            if (checkAll2) checkAll2.checked = false;
            selectedRows.forEach(cb => cb.checked = false);
        } else {
            alert("ì €ì¥ ì‹¤íŒ¨: " + result.message);
        }
    } catch (e) {
        console.error(e);
        alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
}



/** 2ë²ˆ ì˜ì—­: í‘œ ë°ì´í„°ë¥¼ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ **/
function downloadExcel2() {
    const tbody = document.getElementById('qt-matching-body');
    const rows = tbody.querySelectorAll('tr');
    
    // ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì²´í¬
    if (rows.length === 0 || rows[0].innerText.includes("ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤")) {
        return alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    }

    // 1. ì—‘ì…€ì— ë“¤ì–´ê°ˆ í—¤ë” ì •ì˜ (ì‚¬ìš©ìë‹˜ì´ ë°”ê¾¼ ìˆœì„œ ê¸°ì¤€)
    const data = [
        ["ì˜ë¢°ë²ˆí˜¸", "ë°œê¸‰ëŒ€ê¸°ì¼ì", "ì ‘ìˆ˜ë²ˆí˜¸", "ë´‰ì¸ëª…", "ì‹œí—˜Â·ê²€ì‚¬ ì¢…ëª©", "ê³µì‚¬ëª…", "ì ‘ìˆ˜ì¼ì", "ì‹œí—˜Â·ê²€ì‚¬ì§„í–‰ í™•ì •ì¼ì", "ì§„í–‰ìƒíƒœ"]
    ];

    // 2. í‘œì˜ ê° í–‰ì„ ëŒë©´ì„œ ë°ì´í„° ì¶”ì¶œ
    rows.forEach(row => {
        const cells = row.cells;
        data.push([
            cells[1].innerText.trim(), // ì˜ë¢°ë²ˆí˜¸
            cells[2].innerText.trim(), // ë°œê¸‰ëŒ€ê¸°ì¼ì
            cells[3].innerText.trim(), // ì ‘ìˆ˜ë²ˆí˜¸
            cells[4].innerText.trim(), // ë´‰ì¸ëª…
            cells[5].innerText.trim(), // ì‹œí—˜Â·ê²€ì‚¬ ì¢…ëª©
            cells[6].innerText.trim(), // ê³µì‚¬ëª…
            cells[7].innerText.trim(), // ì ‘ìˆ˜ì¼ì
            cells[8].innerText.trim() // ì‹œí—˜Â·ê²€ì‚¬ì§„í–‰ í™•ì •ì¼ì
            // cells[9].innerText.trim()  // ì§„í–‰ìƒíƒœ
        ]);
    });

    // 3. ì—‘ì…€ ì›Œí¬ë¶ ìƒì„± ë° íŒŒì¼ ì €ì¥
    const worksheet = XLSX.utils.aoa_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "ë°œê¸‰ëŒ€ê¸°ëª©ë¡");

    // íŒŒì¼ëª…ì— ì˜¤ëŠ˜ ë‚ ì§œ í¬í•¨ (ì˜ˆ: CSI_ë°œê¸‰ëŒ€ê¸°_20260107.xlsx)
    const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    XLSX.writeFile(workbook, `CSI_ë°œê¸‰ëŒ€ê¸°_${today}.xlsx`);
}

/** 2ë²ˆ ì˜ì—­: ì—‘ì…€ íŒŒì¼ ì½ì–´ì„œ í‘œì— í‘œì‹œ **/
function uploadExcel2(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        // ì²« ë²ˆì§¸ ì‹œíŠ¸ ê°€ì ¸ì˜¤ê¸°
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        
        // ì‹œíŠ¸ ë°ì´í„°ë¥¼ JSON ë°°ì—´ë¡œ ë³€í™˜ (í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„°ë§Œ)
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        if (jsonData.length <= 1) {
            alert("ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const tbody = document.getElementById('qt-matching-body');
        tbody.innerHTML = ''; // ê¸°ì¡´ í‘œ ë‚´ìš© ì´ˆê¸°í™”

        // ì²« ë²ˆì§¸ í–‰ì€ í—¤ë”ì´ë¯€ë¡œ i=1ë¶€í„° ì‹œì‘
        for (let i = 1; i < jsonData.length; i++) {
            const rowData = jsonData[i];
            if (rowData.length === 0) continue;

            // ì—‘ì…€ ì»¬ëŸ¼ ìˆœì„œê°€ ì €ì¥í•  ë•Œì™€ ë™ì¼í•˜ë‹¤ê³  ê°€ì • (ì˜ë¢°ë²ˆí˜¸, ëŒ€ê¸°ì¼ì, ì ‘ìˆ˜ë²ˆí˜¸...)
            // ì—‘ì…€ ìˆœì„œ: 0:ì˜ë¢°ë²ˆí˜¸, 1:ë°œê¸‰ëŒ€ê¸°ì¼ì, 2:ì ‘ìˆ˜ë²ˆí˜¸, 3:ì„±ì ì„œë²ˆí˜¸, 4:ë´‰ì¸ëª…, 5:ê³µì‚¬ëª…, 6:ì˜ë¢°ê¸°ê´€, 7:ì˜ë¢°ì¼ì, 8:ì ‘ìˆ˜ì¼ì
            const htmlRow = `
                <tr>
                    <td class="text-center"><input type="checkbox" class="row-check-2"></td>
                    <td class="text-center"><strong>${rowData[0] || ''}</strong></td>
                    <td class="text-center">${rowData[1] || ''}</td>
                    <td class="text-center">${rowData[2] || ''}</td>
                    <td>${rowData[3] || ''}</td>
                    <td>${rowData[4] || ''}</td>
                    <td>${rowData[5] || ''}</td>
                    <td>${rowData[6] || ''}</td>
                    <td class="text-center">${rowData[7] || ''}</td>
                    <td class="text-center">${rowData[8] || ''}</td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', htmlRow);
        }
        
        alert(`${jsonData.length - 1}ê±´ì˜ ë°ì´í„°ë¥¼ ì—‘ì…€ì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
        // íŒŒì¼ input ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì˜¬ë¦´ ìˆ˜ ìˆë„ë¡)
        event.target.value = '';
    };
    reader.readAsArrayBuffer(file);
}

/** ìˆ¨ê²¨ì§„ íŒŒì¼ ì„ íƒì°½ í´ë¦­ íŠ¸ë¦¬ê±° **/
function triggerExcelUpload2() {
    document.getElementById('excel_file_2').click();
}

// ---------------------------3ë²ˆ ì˜ì—­ì…ë‹ˆë‹¤.-------------------------
let gridApi3;

// 1. ê·¸ë¦¬ë“œ ì»¬ëŸ¼ ì •ì˜ (ì²´í¬ë°•ìŠ¤ ì¶”ê°€)
const columnDefs3 = [
    { 
        headerName: "", 
        checkboxSelection: true,      // ì²´í¬ë°•ìŠ¤ í‘œì‹œ
        headerCheckboxSelection: true, // í—¤ë”ì— ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ í‘œì‹œ
        width: 30,
        maxWidth: 30,                  // ğŸŒŸ ìµœëŒ€ ë„ˆë¹„ ì œí•œ
        minWidth: 30,                  // ğŸŒŸ ìµœì†Œ ë„ˆë¹„ ì œí•œ
        pinned: 'left',                 // ì™¼ìª½ì— ê³ ì • (ì„ íƒ ì‚¬í•­)
        suppressMovable: true,          // ì‚¬ìš©ìê°€ ë“œë˜ê·¸í•´ì„œ ì˜®ê¸°ì§€ ëª»í•˜ê²Œ í•¨
        lockPosition: 'left' // [ì¶”ê°€] ì‚¬ìš©ìê°€ ëŒì–´ì„œ ìˆœì„œë¥¼ ë°”ê¾¸ì§€ ëª»í•˜ê²Œ ê³ ì •
    },
    { headerName: "ID", field: "ID", width: 70, sortable: true, filter: true,pinned: 'left' },
    { headerName: "ì˜ë¢°ë²ˆí˜¸", field: "ì˜ë¢°ë²ˆí˜¸", width: 150, editable: true,pinned: 'left' },
    { headerName: "ì ‘ìˆ˜ë²ˆí˜¸", field: "ì ‘ìˆ˜ë²ˆí˜¸", width: 150, editable: true },
    { headerName: "ì‚¬ì—…ëª…", field: "ì‚¬ì—…ëª…", width: 200, editable: true },
    { headerName: "ì˜ë¢°ê¸°ê´€ëª…", field: "ì˜ë¢°ê¸°ê´€ëª…", width: 180, editable: true },
    { headerName: "ì˜ì—…êµ¬ë¶„", field: "ì˜ì—…êµ¬ë¶„", width: 100, editable: true },
    { headerName: "ë‹´ë‹¹ì", field: "ë‹´ë‹¹ì", width: 100, editable: true }
];

// 2. ê·¸ë¦¬ë“œ ì˜µì…˜ ì„¤ì •
const gridOptions3 = {
    columnDefs: columnDefs3,
    rowData: [],
    rowSelection: 'multiple', // ğŸŒŸ ë‹¤ì¤‘ ì„ íƒ ëª¨ë“œ í™œì„±í™”
    defaultColDef: {
        resizable: true,
        sortable: true,
        filter: true,
        flex: 1,
        minWidth: 100
    },
    onCellValueChanged: function(event) {
        console.log('ë°ì´í„° ìˆ˜ì •ë¨:', event.data);
    },
    onModelUpdated: (event) => {
        const count = event.api.getDisplayedRowCount();
        const element = document.getElementById('total-count-3');
        if (element) element.innerText = count;
    }
};

// 3. í˜ì´ì§€ ë¡œë“œ ì‹œ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
    const gridDiv3 = document.querySelector('#grid-panel-3');
    gridApi3 = agGrid.createGrid(gridDiv3, gridOptions3);
});

// 4. [ë¶ˆëŸ¬ì˜¤ê¸°] ë²„íŠ¼ í•¨ìˆ˜
// 3ë²ˆ ì˜ì—­ [ë¶ˆëŸ¬ì˜¤ê¸°] ë²„íŠ¼ ì‹¤í–‰ í•¨ìˆ˜
function fetchPanel3Data() {
    if (!gridApi3) return;

    const searchType = document.getElementById('search_type_3').value;
    const searchText = document.getElementById('search_text_3').value;

    // ë¡œë”© í‘œì‹œ
    gridApi3.setGridOption('loading', true);

    const url = `/get_panel3_data/?search_type=${searchType}&search_text=${encodeURIComponent(searchText)}`;

    fetch(url)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                alert("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜: " + data.error);
                return;
            }
            // ê·¸ë¦¬ë“œì— ë°ì´í„° ì±„ìš°ê¸°
            gridApi3.setGridOption('rowData', data);
        })
        .catch(err => {
            console.error(err);
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        })
        .finally(() => {
            gridApi3.setGridOption('loading', false);
        });

        fetch(url)
        .then(res => res.json())
        .then(data => {
            gridApi3.setGridOption('rowData', data);
            // ğŸŒŸ ê±´ìˆ˜ ì—…ë°ì´íŠ¸
            document.getElementById('total-count-3').innerText = data.length;
        });
}

// 5. [DB ì €ì¥] ë²„íŠ¼ í•¨ìˆ˜ (ì²´í¬ëœ ê²ƒë§Œ ì €ì¥í•˜ë„ë¡ ìˆ˜ì •)
function savePanel3Data() {
    if (!gridApi3) return;

    // ğŸŒŸ ì„ íƒëœ ë…¸ë“œ(í–‰)ë“¤ë§Œ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const selectedNodes = gridApi3.getSelectedNodes();
    const selectedData = selectedNodes.map(node => node.data);
    
    if (selectedData.length === 0) {
        alert("ì €ì¥í•  ë°ì´í„°ë¥¼ ì„ íƒ(ì²´í¬)í•´ ì£¼ì„¸ìš”.");
        return;
    }

    if (!confirm(`${selectedData.length}ê±´ì˜ ë°ì´í„°ë¥¼ DBì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    fetch('/save_panel3_data/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ items: selectedData }) // ì²´í¬ëœ ë°ì´í„°ë§Œ ì „ì†¡
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            alert("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            // ì €ì¥ í›„ ì„ íƒ í•´ì œ (ì„ íƒ ì‚¬í•­)
            gridApi3.deselectAll();
        } else {
            alert("ì €ì¥ ì‹¤íŒ¨: " + result.error);
        }
    })
    .catch(err => alert("ì €ì¥ ì¤‘ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
}

// CSRF í† í° ì·¨ë“ìš© í•¨ìˆ˜ (ì¥ê³  ê¸°ë³¸)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ------------------------ì—¬ê¸°ì„œ ë¶€í„° ë§ˆì§€ë§‰ 4ë²ˆì§¸ í™”ë©´---------------
// [1] íŒŒì¼ ì„ íƒ ì°½ ì—´ê¸°
function triggerExcelUpload4() {
    document.getElementById('excel_file_4').click();
}

// [2] ì—‘ì…€ íŒŒì¼ ì½ê¸° (Cì—´ ë¹„ê³  ì¶”ê°€)
async function uploadExcel4(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const arrayBuffer = e.target.result;
            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(arrayBuffer);
            
            const worksheet = workbook.getWorksheet(1);
            const excelData = [];

            worksheet.eachRow((row, rowNumber) => {
                if (rowNumber > 1) {
                    const qtNo = row.getCell(1).text; 
                    const amount = row.getCell(2).value;
                    const memo = row.getCell(3).text; // âœ¨ ì¶”ê°€: Cì—´ ì½ê¸°

                    if (qtNo) {
                        excelData.push({
                            id: '',
                            receipt_code: qtNo,
                            applied_amount: amount,
                            memo: memo // âœ¨ ì¶”ê°€
                        });
                    }
                }
            });

            renderPanel4Table(excelData);
            event.target.value = ''; 
        } catch (error) {
            console.error(error);
            alert("ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    };
    reader.readAsArrayBuffer(file);
}

// [3] í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜ (ë¹„ê³  ì…ë ¥ë€ ìƒì„±)
function renderPanel4Table(dataList, isDatabaseFetch = false) {
    const tbody = document.getElementById('panel-4-body');
    const totalCount = document.getElementById('total-count-4');
    const checkAll = document.getElementById('check-all-4');
    
    if (checkAll) checkAll.checked = false; 
    tbody.innerHTML = ''; 
    totalCount.innerText = dataList.length;

    if (dataList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; // âœ¨ colspan 5ë¡œ ìˆ˜ì •
        return;
    }

    dataList.forEach((item) => {
        const row = document.createElement('tr');
        const formattedAmount = Number(item.applied_amount || 0).toLocaleString();
        const displayId = (isDatabaseFetch && item.id) ? item.id : "";
        const idClass = displayId ? "db-id" : "new-id";

        row.innerHTML = `
            <td><input type="checkbox" class="row-checkbox-4"></td>
            <td class="${idClass} text-center font-monospace">${displayId}</td>
            <td>
                <input type="text" class="form-control form-control-sm text-center row-qt" value="${item.receipt_code || ''}">
            </td>
            <td>
                <input type="text" class="form-control form-control-sm text-end fw-bold row-amount" 
                       style="color: #198754;" 
                       value="${formattedAmount}" 
                       onfocus="this.value = this.value.replace(/,/g, '')"
                       onblur="this.value = Number(this.value).toLocaleString()">
            </td>
            <td>
                <input type="text" class="form-control form-control-sm row-memo" 
                       value="${item.memo || ''}" placeholder="ë¹„ê³  ì…ë ¥"> </td>
        `;
        tbody.appendChild(row);
    });
}

// [4] DB ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
async function fetchPanel4Data() {
    const searchInput = document.getElementById('search_qt_no');
    const searchVal = searchInput ? searchInput.value.trim() : "";
    const url = `/api/get_panel4_data?qt_no=${encodeURIComponent(searchVal)}`;
    
    try {
        const response = await fetch(url);
        const result = await response.json();
        if (result.success) {
            renderPanel4Table(result.data, true); // ì—¬ê¸°ì„œ renderPanel4Tableì´ ë¹„ê³ ë¥¼ ê·¸ë ¤ì¤ë‹ˆë‹¤.
            if (result.data.length > 0) {
                alert(`ì¡°íšŒ ì„±ê³µ: ì´ ${result.data.length}ê±´ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
            } else {
                alert("ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
            }
        } else {
            alert("ì¡°íšŒ ì‹¤íŒ¨: " + result.message);
        }
    } catch (error) {
        console.error("Fetch Error:", error);
        alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
}

// [5] DB ì €ì¥ í•¨ìˆ˜ (ë¹„ê³  ê°’ ì¶”ì¶œ ë¡œì§ ë°˜ì˜)
async function savePanel4Data() {
    const saveBtn = document.getElementById('btn-save-4'); // ë²„íŠ¼ ê°€ì ¸ì˜¤ê¸°
    const rows = document.querySelectorAll('#panel-4-body tr');
    const new_items = [];
    const updated_items = [];
    const newRowsDom = []; 

    rows.forEach(row => {
        const checkbox = row.querySelector('.row-checkbox-4');
        if (!checkbox || !checkbox.checked) return;

        const id = row.cells[1].innerText.trim();
        const qt = row.querySelector('.row-qt')?.value.trim();
        const amountStr = row.querySelector('.row-amount')?.value.replace(/,/g, '').trim();
        const amount = amountStr ? Number(amountStr) : 0;
        const memo = row.querySelector('.row-memo')?.value.trim() || "";

        if (!qt) return;

        if (!id) {
            new_items.push({ receipt_code: qt, applied_amount: amount, memo: memo });
            newRowsDom.push(row); 
        } else {
            updated_items.push({ id: id, receipt_code: qt, applied_amount: amount, memo: memo });
        }
    });

    if (new_items.length === 0 && updated_items.length === 0) return alert("ì €ì¥í•  í•­ëª©ì„ ì²´í¬í•´ ì£¼ì„¸ìš”.");
    if (!confirm(`ì´ ${new_items.length + updated_items.length}ê±´ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    try {
        // ğŸŒŸ 1. ë¡œë”© í‘œì‹œ ì‹œì‘
        if (saveBtn) {
            saveBtn.disabled = true; // ì¤‘ë³µ í´ë¦­ ë°©ì§€
            saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ì €ì¥ ì¤‘...`;
        }
        // ë§ˆìš°ìŠ¤ ì»¤ì„œë„ ëª¨ë˜ì‹œê³„ë¡œ ë³€ê²½
        document.body.style.cursor = 'wait';

        const response = await fetch('/api/save_panel4_data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ new_items, updated_items })
        });
        
        const res = await response.json();
        
        if (res.success) {
            if (res.created_ids && res.created_ids.length > 0) {
                newRowsDom.forEach((row, index) => {
                    row.cells[1].innerText = res.created_ids[index];
                    row.cells[1].style.color = "blue";
                });
            }
            rows.forEach(row => {
                const cb = row.querySelector('.row-checkbox-4');
                if (cb) cb.checked = false;
            });
            alert(`ì €ì¥ ì™„ë£Œ! (ì´ ${new_items.length + updated_items.length}ê±´)`);
        } else {
            alert("ì €ì¥ ì‹¤íŒ¨: " + res.message);
        }
    } catch (e) { 
        console.error(e); 
        alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message); 
    } finally {
        // ğŸŒŸ 2. ë¡œë”© í‘œì‹œ ì¢…ë£Œ (ì„±ê³µí•˜ë“  ì—ëŸ¬ê°€ ë‚˜ë“  ì›ë˜ëŒ€ë¡œ ë³µêµ¬)
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerText = "DB ì €ì¥";
        }
        document.body.style.cursor = 'default';
    }
}

// ------------------------ê¶Œí•œì œì–´--------------STR

    /* ê¶Œí•œ ì œì–´ */
document.addEventListener("DOMContentLoaded", function() {
    // 1. ì„œë²„ì—ì„œ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°
    const currentUserId = "{{ request.user.username }}"; 
    
    // 2. í—ˆìš©í•  ì•„ì´ë”” ë¦¬ìŠ¤íŠ¸
    const allowedIds = ["admin_work", "admin_home"]; 

    // ëª¨ë“  ë²„íŠ¼ì„ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.
    const allBtns = [
        document.getElementById('btn-fetch'),   // 1ë²ˆ ì¡°íšŒ
        document.getElementById('btn-save'),    // 1ë²ˆ ì €ì¥
        document.getElementById('btn-fetch-2'), // 2ë²ˆ ì¡°íšŒ
        document.getElementById('btn-save-2'),   // 2ë²ˆ ì €ì¥
        document.getElementById('btn-excel-download-2'), // ì¶”ê°€
        document.getElementById('btn-excel-upload-2')    // ì¶”ê°€
    ];

    // 3. ê¶Œí•œ ì²´í¬ ë¡œì§
    if (allowedIds.includes(currentUserId)) {
        // [ê¶Œí•œ ìˆìŒ] ëª¨ë“  ë²„íŠ¼ í™œì„±í™”
        allBtns.forEach(btn => {
            if (btn) {
                btn.removeAttribute('disabled');
                btn.disabled = false; // í™•ì‹¤íˆ í•˜ê¸° ìœ„í•´ ëª…ì‹œì  ì²˜ë¦¬
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
            }
        });
        console.log("ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ë¨: " + currentUserId);
    } else {
        // [ê¶Œí•œ ì—†ìŒ] ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™” ë° ì‹œê°ì  í”¼ë“œë°±
        allBtns.forEach(btn => {
            if (btn) {
                btn.disabled = true;
                btn.style.opacity = "0.5";
                btn.style.cursor = "not-allowed";
                btn.title = "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.";
                
                // í´ë¦­ ì‹œ ì•Œë¦¼ (ì´ë¯¸ disabledë©´ ì•ˆ ëˆŒë¦¬ì§€ë§Œ ì´ì¤‘ ì ê¸ˆ)
                btn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    alert("í•´ë‹¹ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
                    return false;
                };
            }
        });
        console.log("ê¶Œí•œ ì—†ìŒ: " + currentUserId);
    }
});

// -------------------------ê¶Œí•œì œì–´---------------END

</script>
</html>
{% endblock %}

