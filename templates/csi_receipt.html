{% extends "base.html" %}

{% block title %}CSI ì ‘ìˆ˜ ì‹œìŠ¤í…œ - í•œêµ­ê±´ì„¤í’ˆì§ˆì‹œí—˜ì›(ì£¼){% endblock %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    /* 1. ë¡œë”© ì˜¤ë²„ë ˆì´ */
    #loading-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.85);
        display: none; z-index: 9999;
        flex-direction: column; justify-content: center; align-items: center;
    }

    /* 2. í…Œì´ë¸” ë ˆì´ì•„ì›ƒ ë° í—¤ë” í‹€ê³ ì • */
    .table-responsive {
        overflow: auto; 
        max-height: 75vh; 
        border: 1px solid #dee2e6;
    }
    
    .table {
        table-layout: fixed;
        width: 100%;
        min-width: 2200px; /* ì—´ ì¶”ê°€ë¡œ ì¸í•œ ë„ˆë¹„ í™•ì¥ */
        border-collapse: separate;
        border-spacing: 0;
    }

    .table thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa !important;
        z-index: 10;
        border-bottom: 2px solid #dee2e6;
        box-shadow: inset 0 1px 0 #dee2e6, inset 0 -1px 0 #dee2e6;
        padding: 10px 5px;
    }

    /* í—¤ë” í…ìŠ¤íŠ¸ ê°€ìš´ë° ì •ë ¬ */
.table thead th {
    text-align: center;
    vertical-align: middle;
}

/* ë°°ì •ì¼ì í—¤ë” ë‚´ë¶€ ìš”ì†Œ ì •ë ¬ */
.header-date-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px; /* ê¸€ìì™€ ë‹¬ë ¥ ì‚¬ì´ ê°„ê²© */
}

/* í—¤ë” ë‹¬ë ¥ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€ */
#batch-date-picker {
    width: 24px;
    height: 24px;
    padding: 0;
    border: none;
    background: transparent;
    cursor: pointer;
}

    /* ì—´ ë„ˆë¹„ ì„¤ì • */
    .col-chk { width: 40px; }
    .col-num { width: 50px; }
    .col-rq  { width: 140px; }    /* ì˜ë¢°ë²ˆí˜¸ ì—´ */
    .col-recv { width: 140px; }
    .col-date { width: 100px; }   /* ì ‘ìˆ˜ì¼ì‹œ ì—´ */
    .col-stat { width: 140px; }
    .col-proj { width: 340px; }
    .col-org  { width: 180px; }   /* ì˜ë¢°ê¸°ê´€ëª… ì—´ */
    .col-user { width: 60px; }
    .col-seal { width: 180px; }
    .col-proc { width: 60px; background-color: #e7f3ff; } /* ì²˜ë¦¬ì ì—´ ê°•ì¡° */
    .col-sale { width: 80px; }
    .col-mgr  { width: 70px; }  /* ë‹´ë‹¹ì ì—´ */
    .col-ok   { width: 50px; }
    .col-vol  { width: 190px; }
    .col-type { width: 190px; }
    .col-site { width: 200px; }
    .col-assign-d { width: 120px; }  /* ë°°ì •ì¼ì ì—´ */
    .col-assign-s { width: 110px; }

    .edit-input { 
        border: 1px solid transparent; 
        text-align: center; 
        width: 100%; 
        background-color: transparent; 
        font-size: 0.85rem;
        padding: 5px;
    }
    .edit-input:focus { background-color: #fff9db; border-color: #ffda6a; outline: none; }
</style>

<div id="loading-overlay">
    <div class="spinner-grow text-primary mb-3" role="status"></div>
    <h5 class="fw-bold text-primary" id="loading-text">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</h5>
    <div class="progress" style="width: 300px; height: 10px;">
        <div id="progress-bar" class="progress-bar bg-success" style="width: 0%"></div>
    </div>
</div>

<nav class="main-menu-bar shadow-sm" style="background-color: #0089a7 !important;">
    <div class="container d-flex justify-content-center gap-4 py-2">
        <!-- <a href="/" class="btn btn-lg text-white fw-bold px-4" style="background-color: #005f73; border: 1px solid rgba(255,255,255,0.2);">
            <i class="bi bi-house-door-fill me-2"></i>í™ˆìœ¼ë¡œ
        </a> -->
        <button type="button" class="btn btn-lg text-white fw-bold px-4" onclick="window.handleExcelImport(event)">
            <i class="bi bi-file-earmark-excel me-2"></i> ì—‘ì…€ ê°€ì ¸ì˜¤ê¸°
        </button>
        <button type="button" class="btn btn-lg btn-warning fw-bold px-4" onclick="window.fetchCsiData(event)">
            <i class="bi bi-cloud-download-fill me-2"></i> CSI ë¶ˆëŸ¬ì˜¤ê¸°
        </button>               
        <button type="button" class="btn btn-lg text-white fw-bold px-4" style="background-color: #005f73;" onclick="window.fetchAssignmentHistory(event)">
            <i class="bi bi-person-check-fill me-2"></i> ë‹´ë‹¹ì ë°°ì •í˜„í™© ë¶ˆëŸ¬ì˜¤ê¸°
        </button>
        <!-- <button type="button" class="btn btn-lg text-white fw-bold px-4" onclick="window.handleSaveToDB(event)">
            <i class="bi bi-database-fill-check me-2"></i> DB ì €ì¥í•˜ê¸°
        </button> -->
        <button type="button" id="btn-db-save" class="btn btn-lg text-white fw-bold px-4" onclick="window.handleSaveToDB(event)">
            <i class="bi bi-database-fill-check me-2"></i> DB ì €ì¥í•˜ê¸°
        </button>
    </div>
</nav>

<div class="receipt-board-page container-fluid py-4">
    <div class="content-body-section bg-white p-4 rounded shadow-sm">
        
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
            <h4 class="fw-bold text-primary m-0">
                <i class="bi bi-pencil-square me-2"></i>ì˜ë¢°ì„œ í†µí•© ê´€ë¦¬
            </h4>
            
            <div class="d-flex flex-wrap align-items-center gap-2 bg-light p-2 rounded border">
    <span class="fw-bold small text-secondary"><i class="bi bi-person-badge me-1"></i>ë‹´ë‹¹ì:</span>
    <select id="search-manager" class="form-select form-select-sm" style="width: 90px;">
        <option value="ì „ì²´">ì „ì²´</option>
        <option value="1íŒ€">1íŒ€</option>
        <option value="2íŒ€">2íŒ€</option>
        <option value="3íŒ€">3íŒ€</option>
        <option value="4íŒ€">4íŒ€</option>
        <option value="5íŒ€">5íŒ€</option>
        <option value="6íŒ€">6íŒ€</option>
    </select>

    <div class="input-group input-group-sm" style="width: 280px;">
        <select id="search-filter" class="form-select" style="max-width: 100px;">
            <option value="all">ê²€ìƒ‰í•„í„°</option>
            <option value="u_id">ì˜ë¢°ë²ˆí˜¸</option>
            <option value="project">ì‚¬ì—…ëª…</option>
            <option value="client">ì˜ë¢°ê¸°ê´€</option>
        </select>
        <input type="text" id="search-keyword" class="form-control" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥...">
    </div>

    <span class="fw-bold small text-secondary ms-2"><i class="bi bi-calendar-check me-1"></i>ë°°ì •ì¼:</span>
    <input type="date" id="search-start-date" class="form-control form-control-sm" style="width: 135px;">
    <span class="text-muted">~</span>
    <input type="date" id="search-end-date" class="form-control form-control-sm" style="width: 135px;">
    
    <button class="btn btn-primary btn-sm fw-bold px-3" onclick="searchByDate()">
        <i class="bi bi-search me-1"></i> ê²€ìƒ‰
    </button>

    <div class="vr mx-1"></div>

    <button class="btn btn-success btn-sm fw-bold px-3" onclick="downloadExcel()">
        <i class="bi bi-file-earmark-excel me-1"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    </button>
</div>
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-bordered table-hover align-middle">
                <thead>
                    <tr>
                        <th class="col-chk"><input type="checkbox" id="select-all" onclick="toggleAllCheckboxes(this)"></th>
                        <th class="col-num">ìˆœë²ˆ</th>
                        <th class="col-rq" style="background-color: #fff3cd;">ì˜ë¢°ë²ˆí˜¸</th>
                        <th class="col-recv">ì ‘ìˆ˜ë²ˆí˜¸</th>
                        <th class="col-date">ì ‘ìˆ˜ì¼ì‹œ</th>
                        <th class="col-stat">ì§„í–‰ìƒíƒœ</th>
                        <th class="col-proj">ì‚¬ì—…ëª…</th>
                        <th class="col-org">ì˜ë¢°ê¸°ê´€ëª…</th>
                        <th class="col-user">ì±„ì·¨ì</th>
                        <th class="col-seal">ë´‰ì¸ëª…</th>
                        <th class="col-proc">ì²˜ë¦¬ì</th> 
                        <th class="col-sale">ì˜ì—…êµ¬ë¶„</th>
                        <th class="col-mgr">ë‹´ë‹¹ì</th>
                        <th class="col-ok">í™•ì¸</th>
                        <th class="col-vol">ì‹œë£ŒëŸ‰</th>
                        <th class="col-type">êµ¬ë¶„</th>
                        <th class="col-site">í˜„ì¥ ë‹´ë‹¹ì</th>
                        <th class="col-assign-d">
                            <div class="header-date-container">
                                <span>ë°°ì •ì¼ì</span>
                                <input type="date" id="batch-date-picker" onchange="applyBatchDate(this.value)">
                            </div>
                        </th>
                        <th class="col-assign-s">ë°°ì •í˜„í™©</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const overlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const progressBar = document.getElementById('progress-bar');

    function toggleAllCheckboxes(masterCheckbox) {
        document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = masterCheckbox.checked);
    }

    // 1. ì—‘ì…€ ê°€ì ¸ì˜¤ê¸° (êµ¬ì¡° ìœ ì§€)
    window.handleExcelImport = function(event) {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.xlsx, .xls';

        fileInput.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;

            overlay.style.display = 'flex';
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });

                    const tbody = document.getElementById('table-body');
                    tbody.innerHTML = ''; 
                    let dataCount = 0;

                    rows.forEach((row, index) => {
                        if (index < 4 || !row || row.length < 4 || !row[3]) return; 

                        dataCount++;
                        const tr = document.createElement('tr');
                        tr.className = 'text-center';
                        
                        const map = {
                            rq: row[3] || '', status: row[5] || '', project: row[6] || '', client: row[9] || '',
                            sales: row[4] || '', check: row[12] || '', amount: row[13] || '', type: row[14] || '', manager: row[15] || ''
                        };

                        tr.innerHTML = `
                            <td><input type="checkbox" class="form-check-input row-checkbox"></td>
    <td><input type="text" class="edit-input" data-name="index" value="${dataCount}"></td>
    <td><input type="text" class="edit-input" data-name="u_id" value="${map.rq}"></td>
    
    <td><input type="text" class="edit-input" data-name="receipt_id" value=""></td> 
    <td><input type="text" class="edit-input" data-name="receipt_date" value=""></td> 
    <td><input type="text" class="edit-input" data-name="status" value="${map.status}"></td>
    
    <td><input type="text" class="edit-input" data-name="project" value="${map.project}"></td> 
    <td><input type="text" class="edit-input" data-name="client" value="${map.client}"></td> 
    
    <td><input type="text" class="edit-input" data-name="sampler" value=""></td> 
    <td><input type="text" class="edit-input" data-name="seal" value=""></td> 
    <td><input type="text" class="edit-input" data-name="processor" value=""></td> 
    <td><input type="text" class="edit-input" data-name="sales_type" value="${map.sales}"></td> 
    
    <td>
        <select class="edit-input team-select" data-name="manager" onchange="changeTeamColor(this)">
            <option value="">ì„ íƒ</option>
            <option value="1íŒ€">1íŒ€</option>
            <option value="2íŒ€">2íŒ€</option>
            <option value="3íŒ€">3íŒ€</option>
            <option value="4íŒ€">4íŒ€</option>
            <option value="5íŒ€">5íŒ€</option>
            <option value="6íŒ€">6íŒ€</option>
        </select>
    </td>

    <td><input type="text" class="edit-input" data-name="check_col" value="${map.check}"></td> 
    <td><input type="text" class="edit-input" data-name="amount" value="${map.amount}"></td> 
    <td><input type="text" class="edit-input" data-name="type_col" value="${map.type}"></td> 
    <td><input type="text" class="edit-input" data-name="manager_name" value="${map.manager}"></td> 
    <td>
        <input type="date" class="edit-input date-picker" data-name="assign_date"
               onchange="this.style.backgroundColor='#99ff99'">
    </td>

    <td><input type="text" class="edit-input" data-name="assignment_history" value=""></td> `;
                        tbody.appendChild(tr);
                    });
                    overlay.style.display = 'none';
                } catch (err) {
                    overlay.style.display = 'none';
                    alert("ì—ëŸ¬: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        };
        fileInput.click();
    };

    // 2. CSI ë¶ˆëŸ¬ì˜¤ê¸° (ì²˜ë¦¬ì ì¸ë±ìŠ¤ ìˆ˜ì • ì™„ë£Œ)
    window.fetchCsiData = function(event) {
        const selected = document.querySelectorAll('.row-checkbox:checked');
        if (selected.length === 0) return alert("ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

        const rqNumbers = [];
        const targetRows = [];
        
        selected.forEach(cb => {
            const row = cb.closest('tr');
            const rq = row.querySelectorAll('.edit-input')[1].value; 
            if (rq) { 
                rqNumbers.push(rq); 
                targetRows.push(row); 
            }
        });

        overlay.style.display = 'flex';
        loadingText.innerText = "CSI ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...\n(ì„œë²„ ìƒíƒœì— ë”°ë¼ 1ë¶„ ì´ìƒ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)";
        progressBar.style.width = '20%';

        fetch("{% url 'fetch_csi_data' %}", { 
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'X-CSRFToken': '{{ csrf_token }}' 
            },
            body: JSON.stringify({ rq_numbers: rqNumbers })
        })
        .then(res => {
            if (!res.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (URL ì„¤ì • ë˜ëŠ” ì„œë²„ ìƒíƒœ í™•ì¸)');
            return res.json();
        })
        .then(data => {
            if (data.status === 'success') {
                data.results.forEach((resData, idx) => {
                    const inputs = targetRows[idx].querySelectorAll('.edit-input');
                    
                    // ë°±ì—”ë“œ ë°ì´í„°(resData) ìˆœì„œ: [ì ‘ìˆ˜ë²ˆí˜¸, ì ‘ìˆ˜ì¼ì‹œ, ìƒíƒœ, ì‚¬ì—…ëª…, ì˜ë¢°ê¸°ê´€, ì±„ì·¨ì, ë´‰ì¸ëª…, íŠ¹ì •ì²˜ë¦¬ì]
                    // í‘œì˜ ì…ë ¥ì¹¸(inputs) ì¸ë±ìŠ¤ ë§¤í•‘:
                    // inputs[3]: ì ‘ìˆ˜ë²ˆí˜¸, inputs[4]: ì ‘ìˆ˜ì¼ì‹œ, inputs[5]: ì§„í–‰ìƒíƒœ, inputs[6]: ì‚¬ì—…ëª…,
                    // inputs[7]: ì˜ë¢°ê¸°ê´€ëª…, inputs[8]: ì±„ì·¨ì, inputs[9]: ë´‰ì¸ëª…, inputs[10]: ì²˜ë¦¬ì
                    
                    for(let i=0; i < resData.length; i++) {
                        if(resData[i] !== undefined && inputs[i+2]) {
                            inputs[i+2].value = resData[i];
                        }
                    }
                });
                
                progressBar.style.width = '100%';
                setTimeout(() => { 
                    overlay.style.display = 'none'; 
                    alert(data.message || "ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤."); 
                }, 300);
            } else {
                throw new Error(data.message);
            }
        })
        .catch(err => {
            overlay.style.display = 'none';
            alert("ì‹¤íŒ¨ ì‚¬ìœ : " + err.message);
        });
    };

    // 1. ë‹´ë‹¹ì ì„ íƒ ì‹œ ë°°ê²½ìƒ‰ ë³€ê²½ (ì‚¬ì§„ image_3d5729.png ê¸°ì¤€)
        function changeTeamColor(selectElement) {
            const colors = {
                "1íŒ€": "#ffff00", // ë…¸ë‘
                "2íŒ€": "#ffcc99", // ì‚´êµ¬
                "3íŒ€": "#33ccff", // í•˜ëŠ˜
                "4íŒ€": "#99ff99", // ì—°ë‘
                "5íŒ€": "#c0c0c0", // íšŒìƒ‰
                "6íŒ€": "#ffeb9c"  // ì—°ì£¼í™©
            };
            const selectedValue = selectElement.value;
            selectElement.style.backgroundColor = colors[selectedValue] || "transparent";
            // ê¸€ììƒ‰ë„ ì§„í•˜ê²Œ
            selectElement.style.fontWeight = selectedValue ? "bold" : "normal";
        }

        // 2. ë°°ì •ì¼ì í—¤ë” ì„ íƒ ì‹œ ì „ì²´ í–‰ ì¼ê´„ ì ìš©
        function applyBatchDate(dateValue) {
            if (!dateValue) return;
            
            // í…Œì´ë¸” ë‚´ì˜ ëª¨ë“  ë°°ì •ì¼ì input(date-picker í´ë˜ìŠ¤)ì„ ì°¾ì•„ì„œ ê°’ ë³€ê²½
            const dateInputs = document.querySelectorAll('.date-picker');
            dateInputs.forEach(input => {
                input.value = dateValue;
                input.style.backgroundColor = '#99ff99'; // ì¼ê´„ ë³€ê²½ ì‹œ ì´ˆë¡ìƒ‰ ë°°ê²½ (ì‚¬ì§„ ê°•ì¡°ìƒ‰)
            });
        }

// 3. ë‹´ë‹¹ì ë°°ì •í˜„í™© ë¶ˆëŸ¬ì˜¤ê¸° (MySQL ì¡°íšŒ)
   window.fetchAssignmentHistory = function(event) {
    if (event) event.preventDefault();

    const rows = document.querySelectorAll('#table-body tr');
    const items = [];
    const targetRows = [];

    rows.forEach((row) => {
        // 'data-name' ì†ì„±ìœ¼ë¡œ ì •í™•í•œ ê°’ë“¤ì„ ì¶”ì¶œ
        const projectInput = row.querySelector('[data-name="project"]');
        const clientInput = row.querySelector('[data-name="client"]');
        const uidInput = row.querySelector('[data-name="u_id"]'); // â­ ì˜ë¢°ë²ˆí˜¸(u_id) ì¶”ê°€ ìˆ˜ì§‘
        
        const project = projectInput ? projectInput.value.trim() : "";
        const client = clientInput ? clientInput.value.trim() : "";
        const u_id = uidInput ? uidInput.value.trim() : "";

        // ì‚¬ì—…ëª…ê³¼ ê¸°ê´€ëª…ì´ ìˆì„ ë•Œë§Œ ëª©ë¡ì— ì¶”ê°€
        if (project && client) {
            // â­ ì„œë²„ë¡œ u_idë¥¼ í•¨ê»˜ ë³´ë‚´ì„œ ì €ì¥ ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
            items.push({ project: project, client: client, u_id: u_id });
            targetRows.push(row);
        }
    });

    if (items.length === 0) return alert("ì¡°íšŒí•  ì‚¬ì—…ëª…/ê¸°ê´€ëª… ë°ì´í„°ê°€ í–‰ì— ì—†ìŠµë‹ˆë‹¤.");

    overlay.style.display = 'flex';
    loadingText.innerText = `ê³¼ê±° ì´ë ¥ ë° DB ì €ì¥ ì—¬ë¶€ í™•ì¸ ì¤‘...`; // í…ìŠ¤íŠ¸ ë³€ê²½
    progressBar.style.width = '30%';

    fetch("{% url 'fetch_assignment_history' %}", {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}' 
        },
        body: JSON.stringify({ items: items })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            data.results.forEach((res, idx) => {
                const currentRow = targetRows[idx];
                const rowInputs = currentRow.querySelectorAll('input.edit-input');
                const checkbox = currentRow.querySelector('.row-checkbox');
                
                // 1. ë°°ì •í˜„í™©(ì´ë ¥) ê°’ì„ ë„£ìŠµë‹ˆë‹¤.
                const lastIdx = rowInputs.length - 1;
                if (rowInputs[lastIdx]) {
                    rowInputs[lastIdx].value = res.history || "ì´ë ¥ ì—†ìŒ";
                    rowInputs[lastIdx].style.color = "blue";
                    rowInputs[lastIdx].style.fontWeight = "bold";
                }

                // 2. â­ DBì— ì´ë¯¸ ì €ì¥ëœ ë°ì´í„°ì¸ ê²½ìš° ì‹œê°ì  ë³€í™” ì ìš©
                if (res.is_saved) {
                    currentRow.style.backgroundColor = '#f8f9fa'; // ì—°í•œ íšŒìƒ‰ ë°°ê²½
                    currentRow.style.opacity = '0.7';            // ì•½ê°„ íˆ¬ëª…í•˜ê²Œ
                    
                    if (checkbox) {
                        checkbox.checked = false;        // ì²´í¬ë°•ìŠ¤ í•´ì œ
                        checkbox.disabled = true;        // ì¤‘ë³µ ì €ì¥ ë°©ì§€ë¥¼ ìœ„í•´ ë¹„í™œì„±í™”
                    }

                    // ì„ íƒì‚¬í•­: ì €ì¥ëœ ë°ì´í„°ëŠ” ì‹¤ìˆ˜ë¡œ ìˆ˜ì •í•˜ì§€ ëª»í•˜ë„ë¡ ì…ë ¥ì°½ ì ê¸ˆ
                    currentRow.querySelectorAll('input, select').forEach(el => {
                        // ë°°ì •í˜„í™© ì¹¸ë§Œ ë¹¼ê³  ëª¨ë‘ ì½ê¸° ì „ìš© ì²˜ë¦¬
                        if (el.getAttribute('data-name') !== 'assignment_history') {
                            el.readOnly = true;
                            if(el.tagName === 'SELECT') el.style.pointerEvents = 'none';
                        }
                    });
                }
            });

            progressBar.style.width = '100%';
            setTimeout(() => {
                overlay.style.display = 'none';
                const savedCount = data.results.filter(r => r.is_saved).length;
                alert(`${data.results.length}ê±´ ì¡°íšŒ ì™„ë£Œ!\n(ì´ë¯¸ ì €ì¥ëœ ë°ì´í„° ${savedCount}ê±´ì€ íšŒìƒ‰ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.)`);
            }, 300);
        }
    })
    .catch(err => {
        overlay.style.display = 'none';
        alert("ì—ëŸ¬: " + err.message);
    });
}; 
    

// 4. DB ì €ì¥í•˜ê¸° (MySQLì— ë°ì´í„° ìµœì¢… ê¸°ë¡)
window.handleSaveToDB = function(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€ ì¶”ê°€
    }
    
    const selected = document.querySelectorAll('.row-checkbox:checked');
    if (selected.length === 0) {
        alert("ì €ì¥í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
    }

    if (!confirm(`ì„ íƒí•œ ${selected.length}ê±´ì˜ ë°ì´í„°ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    const saveData = [];
    selected.forEach(cb => {
        const row = cb.closest('tr');
        if (!row) return;

        const rowData = {
            u_id: row.querySelector('[data-name="u_id"]')?.value || "",
            receipt_id: row.querySelector('[data-name="receipt_id"]')?.value || "",
            receipt_date: row.querySelector('[data-name="receipt_date"]')?.value || "",
            status: row.querySelector('[data-name="status"]')?.value || "",
            project: row.querySelector('[data-name="project"]')?.value || "",
            client: row.querySelector('[data-name="client"]')?.value || "",
            sampler: row.querySelector('[data-name="sampler"]')?.value || "",
            seal: row.querySelector('[data-name="seal"]')?.value || "",
            processor: row.querySelector('[data-name="processor"]')?.value || "",
            sales_type: row.querySelector('[data-name="sales_type"]')?.value || "",
            manager: row.querySelector('[data-name="manager"]')?.value || "", 
            check_col: row.querySelector('[data-name="check_col"]')?.value || "",
            amount: row.querySelector('[data-name="amount"]')?.value || "",
            type_col: row.querySelector('[data-name="type_col"]')?.value || "",
            manager_name: row.querySelector('[data-name="manager_name"]')?.value || "",
            assign_date: row.querySelector('[data-name="assign_date"]')?.value || ""
            // assignment_history: row.querySelector('[data-name="assignment_history"]')?.value || ""
        };
        saveData.push(rowData);
    });

    // ë¡œë”© í‘œì‹œ
    if (typeof overlay !== 'undefined') overlay.style.display = 'flex';
    if (typeof loadingText !== 'undefined') loadingText.innerText = "ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...";

    fetch("{% url 'save_to_csi_receipts' %}", {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}' 
        },
        body: JSON.stringify({ data: saveData })
    })
    .then(res => {
        if (!res.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨");
        return res.json();
    })
    .then(data => {
        if (data.status === 'success') {
            alert(data.message || "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            selected.forEach(cb => {
                const row = cb.closest('tr');
                row.style.backgroundColor = '#f8f9fa';
                row.style.opacity = '0.6';
                cb.checked = false;
            });
        } else {
            alert("ì €ì¥ ì‹¤íŒ¨: " + data.message);
        }
    })
    .catch(err => {
        console.error(err);
        alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
    })
    .finally(() => {
        if (typeof overlay !== 'undefined') overlay.style.display = 'none';
    });
}; // <-- í•¨ìˆ˜ëŠ” ì—¬ê¸°ì„œ ë”± í•œ ë²ˆë§Œ ë‹«í˜€ì•¼ í•©ë‹ˆë‹¤.    

// ë””ë¹„ê°€ì ¸ì™€ì„œ ì°½ì— ë¿Œë ¤ì£¼ëŠ” ì½”ë“œì„!
window.searchByDate = function() {
    const tbody = document.getElementById('table-body');
    
    // 1. ê¸°ì¡´ ë°ì´í„° í™•ì¸
    if (tbody && tbody.children.length > 0) {
        if (!confirm("í˜„ì¬ í‘œì— ì‘ì—… ì¤‘ì¸ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. ë¬´ì‹œí•˜ê³  ì¡°íšŒí• ê¹Œìš”?")) return;
    }

    // 2. ê²€ìƒ‰ ì¡°ê±´ ê°€ì ¸ì˜¤ê¸° (ì—˜ë¦¬ë¨¼íŠ¸ê°€ ì—†ì–´ë„ ì—ëŸ¬ ì•ˆ ë‚˜ê²Œ ìˆ˜ì •) â­
    const managerEl = document.getElementById('search-manager');
    const filterEl = document.getElementById('search-filter');
    const keywordEl = document.getElementById('search-keyword');
    const startEl = document.getElementById('search-start-date');
    const endEl = document.getElementById('search-end-date');

    // í•„ìˆ˜ ë‚ ì§œê°’ì´ ì—†ìœ¼ë©´ ì¤‘ë‹¨
    if (!startEl.value || !endEl.value) return alert("ê²€ìƒ‰í•  ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

    const manager = managerEl ? managerEl.value : 'ì „ì²´';
    const filter = filterEl ? filterEl.value : 'all';
    const keyword = keywordEl ? keywordEl.value : '';

    overlay.style.display = 'flex';
    loadingText.innerText = "ë°ì´í„°ë¥¼ ì¡°íšŒ ì¤‘ì…ë‹ˆë‹¤...";

    // 3. ì„œë²„ë¡œ ì „ì†¡
    fetch("{% url 'search_by_assign_date' %}", {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}' 
        },
        body: JSON.stringify({ 
            manager: manager,
            filter: filter,
            keyword: keyword,
            start_date: startEl.value, 
            end_date: endEl.value 
        })
    })
    .then(res => res.json())
    .then(data => {
        console.log("ì„œë²„ ì‘ë‹µ ë°ì´í„°:", data); // ğŸ” F12 ì½˜ì†”ì—ì„œ ë°ì´í„° í™•ì¸ìš©

        if (data.status === 'success') {
            tbody.innerHTML = ''; 

            if (!data.results || data.results.length === 0) {
                alert(`ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }

            // 4. í…Œì´ë¸” ê·¸ë¦¬ê¸°
            data.results.forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.className = 'text-center';
                
                // ë°ì´í„° ë§¤í•‘ (row.u_idê°€ ì—†ìœ¼ë©´ ë¹ˆì¹¸ ì²˜ë¦¬)
                tr.innerHTML = `
                    <td><input type="checkbox" class="form-check-input row-checkbox"></td>
                    <td><input type="text" class="edit-input" data-name="index" value="${idx + 1}"></td>
                    <td><input type="text" class="edit-input" data-name="u_id" value="${row.u_id || ''}"></td>
                    <td><input type="text" class="edit-input" data-name="receipt_id" value="${row.receipt_id || ''}"></td>
                    <td><input type="text" class="edit-input" data-name="receipt_date" value="${row.receipt_date || ''}"></td>
                    <td><input type="text" class="edit-input" data-name="status" value="${row.status || ''}"></td>
                    <td><input type="text" class="edit-input" data-name="project" value="${row.project || ''}"></td>
                    <td><input type="text" class="edit-input" data-name="client" value="${row.client || ''}"></td>
                    <td><input type="text" class="edit-input" data-name="sampler" value="${row.sampler || ''}"></td>
                    <td><input type="text" class="edit-input" data-name="seal" value="${row.seal || ''}"></td>
                    <td><input type="text" class="edit-input" data-name="processor" value="${row.processor || ''}"></td>
                    <td><input type="text" class="edit-input" data-name="sales_type" value="${row.sales_type || ''}"></td>
                    <td>
                        <select class="edit-input team-select" data-name="manager" onchange="changeTeamColor(this)">
                            <option value="">ì„ íƒ</option>
                            <option value="1íŒ€" ${row.manager === '1íŒ€' ? 'selected' : ''}>1íŒ€</option>
                            <option value="2íŒ€" ${row.manager === '2íŒ€' ? 'selected' : ''}>2íŒ€</option>
                            <option value="3íŒ€" ${row.manager === '3íŒ€' ? 'selected' : ''}>3íŒ€</option>
                            <option value="4íŒ€" ${row.manager === '4íŒ€' ? 'selected' : ''}>4íŒ€</option>
                            <option value="5íŒ€" ${row.manager === '5íŒ€' ? 'selected' : ''}>5íŒ€</option>
                            <option value="6íŒ€" ${row.manager === '6íŒ€' ? 'selected' : ''}>6íŒ€</option>
                        </select>
                    </td>
                    <td><input type="text" class="edit-input" data-name="check_col" value="${row.check_col || ''}"></td>
                    <td><input type="text" class="edit-input" data-name="amount" value="${row.amount || ''}"></td>
                    <td><input type="text" class="edit-input" data-name="type_col" value="${row.type_col || ''}"></td>
                    <td><input type="text" class="edit-input" data-name="manager_name" value="${row.manager_name || ''}"></td>
                    <td><input type="date" class="edit-input date-picker" data-name="assign_date" value="${row.assign_date || ''}"></td>
                    <td><input type="text" class="edit-input" data-name="assignment_history" value="${row.assignment_history || ''}"></td>
                `;
                tbody.appendChild(tr);

                const select = tr.querySelector('.team-select');
                if (select && select.value) changeTeamColor(select);
            });
            alert(`${data.results.length}ê±´ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
        } else {
            alert("ì„œë²„ ì˜¤ë¥˜: " + data.message);
        }
    })
    .catch(err => alert("ì¡°íšŒ ì—ëŸ¬: " + err.message))
    .finally(() => overlay.style.display = 'none');
};

// ì—¬ê¸°ì„œ ë¶€í„° ì—‘ì…€ë‹¤ìš´ë¡œë“œ í•˜ê¸° ì½”ë“œì…ë‹ˆë‹¤.
window.downloadExcel = function() {
    console.log("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ ì‹œì‘"); // ì‹¤í–‰ ì—¬ë¶€ í™•ì¸ìš©

    try {
        // XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸
        if (typeof XLSX === 'undefined') {
            alert("ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ë³´ì„¸ìš”.");
            return;
        }

        const table = document.querySelector(".table");
        if (!table) return alert("ë‹¤ìš´ë¡œë“œí•  í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤.");

        const ws_data = [];
        
        // 2. í—¤ë”(thead) ì¶”ì¶œ
        const headers = [];
        const ths = table.querySelectorAll("thead th");
        ths.forEach((th, idx) => {
            if (idx === 0) return; // ì²´í¬ë°•ìŠ¤ ì—´ ì œì™¸
            // í…ìŠ¤íŠ¸ë§Œ ê¹”ë”í•˜ê²Œ ì¶”ì¶œ (ë°°ì •ì¼ìì˜ input ë“± ì œì™¸)
            let headerText = th.innerText.split('\n')[0].replace('ğŸ“…', '').trim();
            headers.push(headerText);
        });
        ws_data.push(headers);

        // 3. ë³¸ë¬¸(tbody) ë°ì´í„° ì¶”ì¶œ
        const rows = table.querySelectorAll("tbody tr");
        if (rows.length === 0) return alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

        rows.forEach(row => {
            const rowData = [];
            const tds = row.querySelectorAll("td");
            
            tds.forEach((td, idx) => {
                if (idx === 0) return; // ì²´í¬ë°•ìŠ¤ ì—´ ì œì™¸
                
                const input = td.querySelector("input, select");
                if (input) {
                    // inputì´ë‚˜ selectì¼ ê²½ìš° í˜„ì¬ ì…ë ¥ëœ ê°’ì„ ê°€ì ¸ì˜´
                    rowData.push(input.value || "");
                } else {
                    rowData.push(td.innerText.trim());
                }
            });
            ws_data.push(rowData);
        });

        // 4. ì›Œí¬ë¶ ìƒì„± ë° íŒŒì¼ ì €ì¥
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        
        // ì—´ ë„ˆë¹„ ì„¤ì •
        ws['!cols'] = headers.map(() => ({ wch: 15 }));

        XLSX.utils.book_append_sheet(wb, ws, "ì˜ë¢°ì„œë‚´ì—­");
        
        const dateStr = new Date().toISOString().slice(0, 10);
        XLSX.writeFile(wb, `ì˜ë¢°ì„œ_ë‚´ì—­_${dateStr}.xlsx`);
        console.log("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ");

    } catch (error) {
        console.error("ë‹¤ìš´ë¡œë“œ ì—ëŸ¬ ìƒì„¸:", error);
        alert("ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
    }
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ ê¶Œí•œ ì²´í¬
document.addEventListener("DOMContentLoaded", function() {
    const currentUserId = "{{ request.user.username }}"; 
    
    // 1. í—ˆìš©í•  ì•„ì´ë””ë“¤ì„ ë°°ì—´ë¡œ ë¬¶ìŠµë‹ˆë‹¤.
    const allowedIds = ["admin_work", "admin_home"]; 

    const saveBtn = document.getElementById('btn-db-save');

    // 2. includes()ë¥¼ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ ì‚¬ìš©ìê°€ ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    if (saveBtn && !allowedIds.includes(currentUserId)) {
        // ê¶Œí•œì´ ì—†ëŠ” ê²½ìš° ë¹„í™œì„±í™” ì²˜ë¦¬
        saveBtn.disabled = true;
        saveBtn.style.backgroundColor = "#6c757d";
        saveBtn.style.opacity = "0.5";
        saveBtn.style.cursor = "not-allowed";
        saveBtn.title = "ê¶Œí•œì´ ìˆëŠ” ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";

        saveBtn.onclick = function(e) {
            e.preventDefault();
            alert("DB ì €ì¥ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
        };
    }
});

</script>
{% endblock %}