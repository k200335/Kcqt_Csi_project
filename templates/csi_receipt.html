{% extends "base.html" %}

{% block title %}CSI 접수 시스템 - 한국건설품질시험원(주){% endblock %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    /* 1. 로딩 오버레이 */
    #loading-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.85);
        display: none; z-index: 9999;
        flex-direction: column; justify-content: center; align-items: center;
    }

    /* 2. 테이블 레이아웃 및 헤더 틀고정 */
    .table-responsive {
        overflow: auto; 
        max-height: 75vh; 
        border: 1px solid #dee2e6;
    }
    
    .table {
        table-layout: fixed;
        width: 100%;
        min-width: 2000px;
        border-collapse: separate;
        border-spacing: 0;
    }

    .table thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa !important;
        z-index: 10;
        border-bottom: 2px solid #dee2e6;
        box-shadow: inset 0 1px 0 #dee2e6, inset 0 -1px 0 #dee2e6;
        padding: 10px 5px;
    }

    /* 열 너비 설정 */
    .col-chk { width: 40px; }
    .col-num { width: 60px; }
    .col-rq  { width: 160px; }
    .col-recv { width: 130px; }
    .col-date { width: 150px; }
    .col-stat { width: 130px; }
    .col-proj { width: 350px; }
    .col-org  { width: 220px; }
    .col-user { width: 100px; }
    .col-seal { width: 130px; }
    .col-sale { width: 110px; }
    .col-mgr  { width: 110px; }
    .col-ok   { width: 110px; }
    .col-vol  { width: 160px; }
    .col-type { width: 190px; }
    .col-site { width: 230px; }
    .col-assign-d { width: 130px; }
    .col-assign-s { width: 110px; }

    .edit-input { 
        border: 1px solid transparent; 
        text-align: center; 
        width: 100%; 
        background-color: transparent; 
        font-size: 0.85rem;
        padding: 5px;
    }
    .edit-input:focus { background-color: #fff9db; border-color: #ffda6a; outline: none; }
</style>

<div id="loading-overlay">
    <div class="spinner-grow text-primary mb-3" role="status"></div>
    <h5 class="fw-bold text-primary" id="loading-text">데이터 처리 중...</h5>
    <div class="progress" style="width: 300px; height: 10px;">
        <div id="progress-bar" class="progress-bar bg-success" style="width: 0%"></div>
    </div>
</div>

<nav class="main-menu-bar shadow-sm" style="background-color: #0089a7 !important;">
    <div class="container d-flex justify-content-center gap-4 py-2">
        <button type="button" class="btn btn-lg text-white fw-bold px-4" onclick="window.handleExcelImport(event)">
            <i class="bi bi-file-earmark-excel me-2"></i> 엑셀 가져오기
        </button>
        <button type="button" class="btn btn-lg btn-warning fw-bold px-4" onclick="window.fetchCsiData(event)">
            <i class="bi bi-cloud-download-fill me-2"></i> CSI 불러오기
        </button>
        <button type="button" class="btn btn-lg text-white fw-bold px-4" onclick="window.handleSaveToDB(event)">
            <i class="bi bi-database-fill-check me-2"></i> DB 저장하기
        </button>
    </div>
</nav>

<div class="receipt-board-page container-fluid py-4">
    <div class="content-body-section bg-white p-4 rounded shadow-sm">
        <h4 class="fw-bold text-primary mb-4"><i class="bi bi-pencil-square me-2"></i>의뢰서 통합 관리</h4>
        <div class="table-responsive">
            <table class="table table-sm table-bordered table-hover align-middle">
                <thead>
                    <tr>
                        <th class="col-chk"><input type="checkbox" id="select-all" onclick="toggleAllCheckboxes(this)"></th>
                        <th class="col-num">순번</th>
                        <th class="col-rq" style="background-color: #fff3cd;">의뢰번호</th>
                        <th class="col-recv">접수번호</th>
                        <th class="col-date">접수일시</th>
                        <th class="col-stat">진행상태</th>
                        <th class="col-proj">사업명</th>
                        <th class="col-org">의뢰기관명</th>
                        <th class="col-user">채취자</th>
                        <th class="col-seal">봉인명</th>
                        <th class="col-sale">영업구분</th>
                        <th class="col-mgr">담당자</th>
                        <th class="col-ok">확인</th>
                        <th class="col-vol">시료량</th>
                        <th class="col-type">구분</th>
                        <th class="col-site">현장 담당자</th>
                        <th class="col-assign-d">배정일자</th>
                        <th class="col-assign-s">배정현황</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // 전역 변수 설정 (ID 일치시킴)
    const overlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const progressBar = document.getElementById('progress-bar');

    function toggleAllCheckboxes(masterCheckbox) {
        document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = masterCheckbox.checked);
    }

    // 1. 엑셀 가져오기
    window.handleExcelImport = function(event) {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.xlsx, .xls';

        fileInput.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;

            overlay.style.display = 'flex';
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });

                    const tbody = document.getElementById('table-body');
                    tbody.innerHTML = ''; 
                    let dataCount = 0;

                    rows.forEach((row, index) => {
                        if (index < 4 || !row || row.length < 4 || !row[3]) return; 

                        dataCount++;
                        const tr = document.createElement('tr');
                        tr.className = 'text-center';
                        
                        const map = {
                            rq: row[3] || '', status: row[5] || '', project: row[6] || '', client: row[9] || '',
                            sales: row[4] || '', check: row[12] || '', amount: row[13] || '', type: row[14] || '', manager: row[15] || ''
                        };

                        tr.innerHTML = `
                            <td><input type="checkbox" class="form-check-input row-checkbox"></td>
                            <td><input type="text" class="edit-input" value="${dataCount}"></td>
                            <td><input type="text" class="edit-input" value="${map.rq}"></td>
                            <td><input type="text" class="edit-input" value=""></td>
                            <td><input type="text" class="edit-input" value=""></td>
                            <td><input type="text" class="edit-input" value="${map.status}"></td>
                            <td><input type="text" class="edit-input" value="${map.project}"></td>
                            <td><input type="text" class="edit-input" value="${map.client}"></td>
                            <td><input type="text" class="edit-input" value=""></td>
                            <td><input type="text" class="edit-input" value=""></td>
                            <td><input type="text" class="edit-input" value="${map.sales}"></td>
                            <td><input type="text" class="edit-input" value=""></td>
                            <td><input type="text" class="edit-input" value="${map.check}"></td>
                            <td><input type="text" class="edit-input" value="${map.amount}"></td>
                            <td><input type="text" class="edit-input" value="${map.type}"></td>
                            <td><input type="text" class="edit-input" value="${map.manager}"></td>
                            <td><input type="text" class="edit-input" value=""></td>
                            <td><input type="text" class="edit-input" value=""></td>
                        `;
                        tbody.appendChild(tr);
                    });
                    overlay.style.display = 'none';
                } catch (err) {
                    overlay.style.display = 'none';
                    alert("에러: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        };
        fileInput.click();
    };

    // 2. CSI 불러오기 (수정 완료)
    window.fetchCsiData = function(event) {
        const selected = document.querySelectorAll('.row-checkbox:checked');
        if (selected.length === 0) return alert("대상을 선택해주세요.");

        const rqNumbers = [];
        const targetRows = [];
        
        selected.forEach(cb => {
            const row = cb.closest('tr');
            const rq = row.querySelectorAll('.edit-input')[1].value; 
            if (rq) { 
                rqNumbers.push(rq); 
                targetRows.push(row); 
            }
        });

        overlay.style.display = 'flex';
        loadingText.innerText = "CSI 데이터를 가져오는 중입니다...\n(서버 상태에 따라 1분 이상 소요될 수 있습니다.)";
        progressBar.style.width = '20%';

        fetch("{% url 'fetch_csi_data' %}", { 
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'X-CSRFToken': '{{ csrf_token }}' 
            },
            body: JSON.stringify({ rq_numbers: rqNumbers })
        })
        .then(res => {
            if (!res.ok) throw new Error('서버 응답 오류 (URL 설정 또는 서버 상태 확인)');
            return res.json();
        })
        .then(data => {
            if (data.status === 'success') {
                data.results.forEach((resData, idx) => {
                    const inputs = targetRows[idx].querySelectorAll('.edit-input');
                    // 백엔드 순서: [접수번호, 접수일시, 상태, 사업명, 의뢰기관, 채취자, 봉인명]
                    // 표의 위치: 인덱스 3(접수번호)부터 하나씩 채움
                    for(let i=0; i < resData.length; i++) {
                        if(resData[i] !== undefined) {
                            // resData[0] -> inputs[3], resData[1] -> inputs[4]...
                            inputs[i+1].value = resData[i];
                        }
                    }
                });
                
                progressBar.style.width = '100%';
                setTimeout(() => { 
                    overlay.style.display = 'none'; 
                    alert(data.message || "성공적으로 불러왔습니다."); 
                }, 300);
            } else {
                throw new Error(data.message);
            }
        })
        .catch(err => {
            overlay.style.display = 'none';
            alert("실패 사유: " + err.message);
        });
    };
</script>
{% endblock %}